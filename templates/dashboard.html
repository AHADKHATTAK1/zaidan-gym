<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>              
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Premium Gym Management & POS System" />
    <meta name="color-scheme" content="light dark">
    <!-- CSS for theme colors - compatible with all browsers -->
    <style>
      html, body {
        background-color: #00C46C;
      }
      @media (prefers-color-scheme: dark) {
        html, body {
          background-color: #22292f !important;
        }
      }
    </style>
    <meta name="msapplication-TileColor" content="#00C46C" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="icon" type="image/png" href="{{ logo_url or '/static/favicon.png' }}" />
    <link rel="apple-touch-icon" href="{{ logo_url or '/static/favicon.png' }}" />
    <link rel="manifest" href="/manifest.json" />
    <title>Dashboard - {{ gym_name }}</title>
    <script>
      (function () {
        try {
          var th = localStorage.getItem("theme") || "dark";
          document.documentElement.setAttribute("data-bs-theme", th);
        } catch (e) {}
      })();
    </script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="/static/css/theme.css" />
  </head>
  <body class="p-4">
    <div class="container">
      <nav class="navbar navbar-expand border rounded px-3 mb-3">
        <a
          class="navbar-brand d-flex align-items-center gap-2"
          href="/dashboard"
        >
          {% if logo_url %}
          <img
            src="{{ logo_url }}"
            alt="{{ gym_name }} Logo"
            title="{{ gym_name }}"
            class="navbar-logo"
          />
          {% endif %}
          <span class="brand">{{ gym_name }}</span>
        </a>
        <div class="ms-auto d-flex align-items-center gap-2">
          <span class="badge text-bg-secondary"
            >{{ monthly_price }} {{ currency_code }}/mo</span
          >
          <span class="fs-5" id="defaultFlag" title="Default Country"></span>
          <span class="me-3">Hello, {{username}}</span>
          <button
            class="btn btn-sm btn-outline-light me-2"
            data-bs-toggle="modal"
            data-bs-target="#settingsModal"
          >
            <i class="bi bi-gear"></i> Settings
          </button>
          <button
            class="btn btn-sm btn-outline-light"
            id="themeToggle"
            title="Toggle theme"
          >
            <i class="bi bi-moon-stars"></i>
          </button>
          <a class="btn btn-sm btn-outline-secondary me-2" href="/members"
            >Members</a
          >
          <a class="btn btn-sm btn-outline-primary me-2" href="/fees">Fees</a>
          <a class="btn btn-sm btn-outline-danger" href="/logout">Logout</a>
        </div>
      </nav>
      <hr />

      <div class="row g-3 mb-4">
        <div class="col-12 mb-2 d-flex gap-2">
          <button
            class="btn btn-outline-warning btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#backupManagerModal"
            title="Manage system backups"
          >
            <i class="bi bi-database me-1"></i>Backup Manager
          </button>
          <button
            id="btnCreateBackup"
            class="btn btn-outline-success btn-sm"
            onclick="createBackup()"
            title="Create new backup now"
          >
            <i class="bi bi-cloud-arrow-up me-1"></i>Create Backup
          </button>
          <button
            id="btnDownloadBackup"
            class="btn btn-outline-secondary btn-sm"
            onclick="downloadBackup()"
          >
            <i class="bi bi-download me-1"></i>Download Backup
          </button>
          <a class="btn btn-outline-secondary btn-sm" href="/members"
            ><i class="bi bi-people me-1"></i>Manage Members</a
          >
          <a class="btn btn-outline-success btn-sm" href="/fees"
            ><i class="bi bi-cash-coin me-1"></i>Monthly Fees</a
          >
          <a class="btn btn-outline-primary btn-sm" href="/dashboard/excel"
            ><i class="bi bi-file-earmark-excel me-1"></i>Excel Dashboard</a
          >
          <a class="btn btn-outline-success btn-sm" href="/dashboard/analytics"
            ><i class="bi bi-bar-chart me-1"></i>Advanced Analytics</a
          >
          <button
            class="btn btn-outline-info btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#monthlyFeesModal"
            title="View detailed monthly fees analysis"
          >
            <i class="bi bi-graph-up me-1"></i>Fees Analysis
          </button>
          <button
            id="btnSystemReset"
            class="btn btn-outline-danger btn-sm"
            title="Reset system to factory defaults"
            onclick="confirmSystemReset()"
          >
            <i class="bi bi-exclamation-triangle me-1"></i>System Reset
          </button>
          <button
            id="btnSendReminders"
            class="btn btn-outline-info btn-sm"
            title="Send monthly fee reminders now"
            onclick="sendRemindersNow()"
          >
            <i class="bi bi-bell me-1"></i>Send Reminders
          </button>
        </div>
        <div class="col-md-3">
          <a class="text-decoration-none" href="/members">
            <div class="card text-center kpi-card kpi-delay-0">
              <div class="card-body">
                <div class="text-muted">Members</div>
                <div class="display-6">{{total_members}}</div>
              </div>
            </div>
          </a>
        </div>
        <div class="col-md-3">
          <a
            class="text-decoration-none"
            href="/fees?year={{year}}&month={{month}}#paid"
          >
            <div class="card text-center kpi-card kpi-delay-05">
              <div class="card-body">
                <div class="text-muted">Paid ({{month}}/{{year}})</div>
                <div class="display-6 text-success">{{paid_count}}</div>
              </div>
            </div>
          </a>
        </div>
        <div class="col-md-3">
          <a
            class="text-decoration-none"
            href="/fees?year={{year}}&month={{month}}#unpaid"
          >
            <div class="card text-center kpi-card kpi-delay-1">
              <div class="card-body">
                <div class="text-muted">Unpaid ({{month}}/{{year}})</div>
                <div class="display-6 text-warning">{{unpaid_count}}</div>
              </div>
            </div>
          </a>
        </div>
        <div class="col-md-3">
          <a
            class="text-decoration-none"
            href="/fees?year={{year}}&month={{month}}#na"
          >
            <div class="card text-center kpi-card kpi-delay-15">
              <div class="card-body">
                <div class="text-muted">N/A ({{month}}/{{year}})</div>
                <div class="display-6 text-secondary">{{na_count}}</div>
              </div>
            </div>
          </a>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">This Year Overview</h5>
            <div class="d-flex align-items-center gap-2">
              <label class="form-label mb-0 small" for="statYear">Year</label>
              <input
                id="statYear"
                class="form-control form-control-sm"
                type="number"
                aria-label="Statistics year"
                title="Select year for statistics"
              />
              <button
                class="btn btn-sm btn-outline-primary"
                onclick="loadStats()"
                aria-label="Refresh statistics"
                title="Refresh statistics"
              >
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
            </div>
          </div>
          <canvas id="feesChart" height="100"></canvas>
        </div>
      </div>

      <!-- Day View - Unpaid Members -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">
              <i class="bi bi-calendar-check me-1"></i>View Unpaid by Date
            </h5>
            <div class="d-flex gap-2 align-items-center">
              <label class="form-label mb-0 small" for="dayViewDate">Select Date</label>
              <input
                id="dayViewDate"
                class="form-control form-control-sm"
                type="date"
                aria-label="Select date to view unpaid"
                title="Select date to view unpaid members"
              />
              <button
                class="btn btn-sm btn-outline-primary"
                onclick="loadUnpaidForDate()"
                aria-label="Show unpaid members"
                title="Show unpaid members for selected date"
              >
                <i class="bi bi-search"></i> Show Unpaid
              </button>
            </div>
          </div>
          <div id="dayViewResults" class="mt-3">
            <div class="text-muted small">Select a date and click Show Unpaid to view members with unpaid fees.</div>
          </div>
        </div>
      </div>

      <!-- Monthly Details Card -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="bi bi-calendar-month me-1"></i>Monthly Details
          </h5>
          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label class="form-label" for="monthDetailInput">Select Month</label>
              <input
                id="monthDetailInput"
                class="form-control"
                type="month"
                pattern="[0-9]{4}-[0-9]{2}"
                aria-label="Select month for detailed view"
                title="Select month for detailed view (YYYY-MM format)"
                placeholder="YYYY-MM"
              />
            </div></invoke>
            <div class="col-md-auto">
              <button
                class="btn btn-primary"
                onclick="loadMonthlyDetails()"
                aria-label="View monthly details"
                title="View monthly payment details"
              >
                <i class="bi bi-eye"></i> View Details
              </button>
            </div>
            <div class="col-md-auto">
              <button
                type="button"
                class="btn btn-outline-secondary d-none"
                onclick="printMonthlyDetails()"
                id="btnPrintMonthly"
                aria-label="Print monthly details"
                title="Print monthly report"
              >
                <i class="bi bi-printer"></i> Print
              </button>
            </div>
            <div class="col-md-auto">
              <button
                type="button"
                class="btn btn-outline-success d-none"
                onclick="exportMonthlyCSV()"
                id="btnExportMonthly"
                aria-label="Export to CSV"
                title="Download monthly data as CSV"
              >
                <i class="bi bi-file-earmark-spreadsheet"></i> Export CSV
              </button>
            </div>
          </div>
          <div id="monthlyDetailsResults" class="mt-3">
            <div class="text-muted small">Select a month to view payment statistics and member details.</div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="bi bi-whatsapp me-1 text-success"></i>WhatsApp Test
          </h5>
          <div class="mb-2">
            <span id="waCfgBadge" class="badge text-bg-secondary"
              >Checking WhatsApp configuration‚Ä¶</span
            >
          </div>
          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Phone (with country code)</label>
              <div class="input-group">
                <span class="input-group-text" id="waToFlag">üåê</span>
                <input
                  id="waTo"
                  class="form-control"
                  placeholder="+91XXXXXXXXXX"
                />
              </div>
            </div>
            <div class="col-md-7">
              <label class="form-label">Message</label>
              <input
                id="waMsg"
                class="form-control"
                placeholder="Hello from Gym Tracker"
              />
            </div>
            <div class="col-md-2">
              <button class="btn btn-success w-100" onclick="sendWaTest()">
                <i class="bi bi-send"></i> Send
              </button>
            </div>
          </div>
        </div>
      </div>

      <h4>Recent Members</h4>
      <table class="table table-sm">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Admission</th>
          </tr>
        </thead>
        <tbody>
          {% for m in recent_members %}
          <tr>
            <td>{{m.id}}</td>
            <td>{{m.name}}</td>
            <td>{{m.phone}}</td>
            <td>{{m.admission_date}}</td>
          </tr>
          {% endfor %} {% if recent_members|length == 0 %}
          <tr>
            <td colspan="4" class="text-muted">No members yet</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    
    <!-- Pay Confirmation Modal -->
    <div class="modal fade" id="payModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light border border-success">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-cash-coin"></i> Confirm Payment</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Payment Method</label>
              <select id="payMethod" class="form-select">
                <option value="cash" selected>Cash</option>
                <option value="bank">Bank</option>
                <option value="online">Online</option>
              </select>
              <div class="form-text">Choose how the member paid.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Amount</label>
              <input id="payAmount" type="number" min="0" step="0.01" class="form-control" placeholder="Leave blank to use default" />
              <div class="form-text">Blank uses member fee or gym monthly price.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
            <button id="payConfirmBtn" class="btn btn-success" data-member-id="" data-year="" data-month="">Confirm & Slip</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="collectedDetailsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light border border-success">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">
              <i class="bi bi-cash-stack"></i> Collected This Month - Detailed Breakdown
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <div class="card bg-dark border-success">
                  <div class="card-body text-center">
                    <small class="text-muted">Total Collected</small>
                    <h4 id="collectedTotal" class="text-success mb-0">0 PKR</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-dark border-info">
                  <div class="card-body text-center">
                    <small class="text-muted">Paid Members</small>
                    <h4 id="collectedCount" class="text-info mb-0">0</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-dark border-warning">
                  <div class="card-body text-center">
                    <small class="text-muted">Average Fee</small>
                    <h4 id="collectedAvg" class="text-warning mb-0">0 PKR</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-dark border-primary">
                  <div class="card-body text-center">
                    <small class="text-muted">Month/Year</small>
                    <h4 id="collectedMonth" class="text-primary mb-0">-</h4>
                  </div>
                </div>
              </div>
            </div>

            <div class="card bg-dark border-success">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-people"></i> Paid Members Details</h6>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-dark table-hover table-sm">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Amount</th>
                        <th>Paid Date</th>
                        <th>Admission</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody id="collectedMembersTable">
                      <tr><td colspan="8" class="text-center">Loading...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success" onclick="exportCollectedData()">
              <i class="bi bi-download"></i> Export Data
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light border border-secondary">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-gear"></i> Settings</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <h6>General</h6>
                <div class="mb-2">
                  <label class="form-label">Gym Name</label>
                  <input
                    id="setGymName"
                    class="form-control"
                    value="{{ gym_name }}"
                  />
                </div>
                <div class="mb-2">
                  <label class="form-label">Currency Code</label>
                  <input
                    id="setCurrency"
                    class="form-control"
                    value="{{ currency_code }}"
                  />
                </div>
                <div class="mb-2">
                  <label class="form-label">Monthly Price</label>
                  <input
                    id="setPrice"
                    class="form-control"
                    value="{{ monthly_price }}"
                  />
                </div>
                <div class="mb-2">
                  <label class="form-label"
                    >WhatsApp Default Country Code</label
                  >
                  <input
                    id="setWaCC"
                    class="form-control"
                    placeholder="e.g. 92"
                  />
                  <div class="form-text">
                    Used when numbers are saved without a +country code.
                  </div>
                </div>
                <button class="btn btn-primary" onclick="saveGeneralSettings()">
                  Save General
                </button>
              </div>
              <div class="col-md-6">
                <h6>Brand Logo</h6>
                <div class="mb-2">
                  <img
                    src="{{ logo_url or '' }}"
                    alt="{{ gym_name }} Logo"
                    class="settings-logo"
                    onerror="this.style.display='none'"
                  />
                </div>
                <div class="mb-2">
                  <input
                    id="logoFile"
                    type="file"
                    accept="image/png,image/jpeg,image/webp"
                    class="form-control"
                  />
                </div>
                <button class="btn btn-secondary" onclick="uploadLogo()">
                  Upload Logo
                </button>
              </div>
              <div class="col-12">
                <hr/>
                <h6><i class="bi bi-bell"></i> Monthly Reminders</h6>
                <div class="mb-2">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="reminderEnabled" />
                    <label class="form-check-label" for="reminderEnabled">
                      Enable automatic monthly fee reminders
                    </label>
                  </div>
                  <div class="form-text">Send WhatsApp reminders to unpaid members every month</div>
                </div>
                <div class="row g-2 mb-2">
                  <div class="col-md-6">
                    <label class="form-label">Reminder Time (Hour)</label>
                    <input id="reminderHour" type="number" min="0" max="23" class="form-control" placeholder="9" />
                    <div class="form-text">24-hour format (0-23)</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Reminder Time (Minute)</label>
                    <input id="reminderMinute" type="number" min="0" max="59" class="form-control" placeholder="0" />
                  </div>
                </div>
                <div class="mb-2">
                  <span class="badge text-bg-secondary" id="reminderStatus">Checking...</span>
                </div>
                <button class="btn btn-primary" onclick="saveReminderSettings()">
                  Save Reminder Settings
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-light"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="monthlyFeesModal" tabindex="-1" aria-labelledby="monthlyFeesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light border border-info">
          <div class="modal-header">
            <h5 class="modal-title" id="monthlyFeesModalLabel">
              <i class="bi bi-graph-up text-info"></i> Monthly Fees Analysis
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs mb-3" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="current-tab" data-bs-toggle="tab" data-bs-target="#current" type="button" role="tab">
                  <i class="bi bi-calendar-month"></i> Current Month
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                  <i class="bi bi-clock-history"></i> Payment History
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="unpaid-tab" data-bs-toggle="tab" data-bs-target="#unpaid" type="button" role="tab">
                  <i class="bi bi-exclamation-circle"></i> Unpaid Members
                </button>
              </li>
            </ul>

            <div class="tab-content">
              <div class="tab-pane fade show active" id="current" role="tabpanel">
                <div class="row g-3 mb-3">
                  <div class="col-md-4">
                    <div class="card text-center">
                      <div class="card-body">
                        <h6 class="text-success">Paid</h6>
                        <h3 id="currentPaid">0</h3>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card text-center">
                      <div class="card-body">
                        <h6 class="text-warning">Unpaid</h6>
                        <h3 id="currentUnpaid">0</h3>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card text-center">
                      <div class="card-body">
                        <h6 class="text-info">Collected</h6>
                        <h3 id="currentCollected">0 PKR</h3>
                      </div>
                    </div>
                  </div>
                </div>
                <h6>Current Month Members</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-hover">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Amount</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody id="currentMembersTable">
                      <tr><td colspan="5" class="text-center">Loading...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="tab-pane fade" id="history" role="tabpanel">
                <div class="mb-3">
                  <label class="form-label">Select Month</label>
                  <div class="row g-2">
                    <div class="col-md-6">
                      <select id="historyMonth" class="form-select">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <input id="historyYear" type="number" class="form-control" placeholder="Year" />
                    </div>
                    <div class="col-md-2">
                      <button class="btn btn-primary w-100" onclick="loadHistoryMonth()">Load</button>
                    </div>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table table-sm table-hover">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Amount</th>
                        <th>Paid Date</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody id="historyTable">
                      <tr><td colspan="5" class="text-center">Select month to view</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="tab-pane fade" id="unpaid" role="tabpanel">
                <h6>Members with Pending Payments</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-hover">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Last Paid</th>
                        <th>Months Unpaid</th>
                        <th>Total Due</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody id="unpaidTable">
                      <tr><td colspan="6" class="text-center">Loading...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success" onclick="payMemberThisMonth()">
              <i class="bi bi-cash-coin"></i> Pay This Month & Slip
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="memberDetailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-light border border-primary">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-person-circle"></i> Complete Member Details
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="card bg-dark border-info mb-3">
              <div class="card-header bg-info text-dark">
                <h6 class="mb-0"><i class="bi bi-person-badge"></i> Personal Information</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-3">
                    <small class="text-muted">Full Name</small>
                    <div id="detailName" class="fw-bold">-</div>
                  </div>
                  <div class="col-md-3">
                    <small class="text-muted">Phone</small>
                    <div id="detailPhone">-</div>
                  </div>
                  <div class="col-md-3">
                    <small class="text-muted">Email</small>
                    <div id="detailEmail">-</div>
                  </div>
                  <div class="col-md-3">
                    <small class="text-muted">CNIC</small>
                    <div id="detailCNIC">-</div>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted">Address</small>
                    <div id="detailAddress">-</div>
                  </div>
                  <div class="col-md-3">
                    <small class="text-muted">Gender</small>
                    <div id="detailGender">-</div>
                  </div>
                  <div class="col-md-3">
                    <small class="text-muted">Date of Birth</small>
                    <div id="detailDOB">-</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card bg-dark border-success mb-3">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-calendar-check"></i> Membership Details</h6>
              </div>
              <div class="card-body">
                <div id="admissionMonthPaidStatus" class="mb-3"></div>
                <div class="row g-3">
                  <div class="col-md-3">
                    <small class="text-muted">Admission Date</small>
                    <div id="detailAdmission" class="fw-bold">-</div>
                  </div>
                  <div class="col-md-3">
                    <small class="text-muted">Monthly Fee</small>
                    <div id="detailMonthlyFee" class="text-warning">-</div>
                  </div>
                  <div class="col-md-3">
                    <small class="text-muted">Referred By</small>
                    <div id="detailReferred">-</div>
                  </div>
                  <div class="col-md-3">
                    <small class="text-muted">Status</small>
                    <div id="detailStatus">-</div>
                  </div>
                  <div class="col-md-12">
                    <small class="text-muted">Notes</small>
                    <div id="detailNotes" class="text-muted fst-italic">-</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-3">
                <div class="card bg-dark border-success">
                  <div class="card-body text-center">
                    <small class="text-muted">Total Paid</small>
                    <h5 id="detailTotalPaid" class="text-success mb-0">-</h5>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-dark border-danger">
                  <div class="card-body text-center">
                    <small class="text-muted">Total Due</small>
                    <h5 id="detailTotalDue" class="text-danger mb-0">-</h5>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-dark border-primary">
                  <div class="card-body text-center">
                    <small class="text-muted">Last Paid Month</small>
                    <h5 id="memberLastPaid" class="text-primary mb-0">-</h5>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-dark border-warning">
                  <div class="card-body text-center">
                    <small class="text-muted">Months Unpaid</small>
                    <h5 id="memberUnpaidCount" class="text-warning mb-0">0</h5>
                  </div>
                </div>
              </div>
            </div>

            <div class="card bg-dark border-primary">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> Payment Timeline</h6>
              </div>
              <div class="card-body">
                <div id="memberTimeline" class="list-group">
                  <div class="text-center py-3">Loading...</div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Backup Manager Modal -->
    <div class="modal fade" id="backupManagerModal" tabindex="-1" aria-labelledby="backupManagerModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="backupManagerModalLabel"><i class="bi bi-database me-2"></i> Backup Manager</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">Available Backups</h6>
              <div>
                <span class="badge bg-secondary" id="backupCount">0 backups</span>
                <span class="badge bg-info ms-2" id="backupSize">0 MB</span>
              </div>
            </div>
            
            <div id="backupListStatus" class="alert alert-info">
              <i class="bi bi-hourglass-split"></i> Loading backups...
            </div>
            
            <div class="table-responsive d-none" id="backupTableContainer">
              <table class="table table-dark table-hover">
                <thead>
                  <tr>
                    <th>Filename</th>
                    <th>Created</th>
                    <th>Size</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="backupTableBody">
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="refreshBackupList()">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="systemResetModal" tabindex="-1" aria-labelledby="systemResetModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light border border-danger">
          <div class="modal-header">
            <h5 class="modal-title" id="systemResetModalLabel"><i class="bi bi-exclamation-triangle text-warning"></i> Confirm System Reset</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p class="mb-2">This will erase all data and reset settings to defaults.</p>
            <ul>
              <li>Members, fees, attendance records</li>
              <li>Uploads and generated snapshots</li>
              <li>Settings reset to factory defaults</li>
            </ul>
            <p class="fw-semibold text-danger">This action cannot be undone.</p>
            <label for="resetConfirmInput" class="form-label">Type <code>RESET</code> to confirm:</label>
            <input type="text" id="resetConfirmInput" class="form-control" aria-describedby="resetHelp" placeholder="RESET">
            <div id="resetHelp" class="form-text">Safety check to prevent accidental resets.</div>
            <div class="mt-2" id="resetStatus" role="status" aria-live="polite"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmSystemResetBtn">Reset System</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Toast notification container -->
    <div id="toastArea" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
    <script>
            // Toast notification function
            function showToast(message, type) {
              try {
                const area = document.getElementById('toastArea');
                const level = (type || 'success').toLowerCase();
                const cls = level === 'success' ? 'text-bg-success' : level === 'warning' ? 'text-bg-warning' : level === 'info' ? 'text-bg-info' : 'text-bg-danger';
                const el = document.createElement('div');
                el.className = `toast align-items-center ${cls} border-0`;
                el.setAttribute('role', 'alert');
                el.setAttribute('aria-live', 'assertive');
                el.setAttribute('aria-atomic', 'true');
                el.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
                area.appendChild(el);
                const t = new bootstrap.Toast(el, { delay: 3500 });
                t.show();
                el.addEventListener('hidden.bs.toast', () => el.remove());
              } catch (e) {
                alert(message);
              }
            }
            
            const DEFAULT_CC = "{{ default_cc }}";
            const CC_TO_ISO = {
              92: "PK",
              91: "IN",
              1: "US",
              44: "GB",
              971: "AE",
              974: "QA",
              966: "SA",
              880: "BD",
              977: "NP",
              94: "LK",
              60: "MY",
              65: "SG",
              61: "AU",
              81: "JP",
              49: "DE",
              33: "FR",
              39: "IT",
              86: "CN",
              7: "RU",
              34: "ES",
              351: "PT",
              41: "CH",
              31: "NL",
              90: "TR",
              20: "EG",
              62: "ID",
              63: "PH",
              64: "NZ",
              82: "KR",
              55: "BR",
              52: "MX",
              27: "ZA",
              972: "IL",
              98: "IR",
              964: "IQ",
              965: "KW",
              968: "OM",
              973: "BH",
              216: "TN",
              213: "DZ",
              254: "KE",
              255: "TZ",
              256: "UG",
            };
            function isoToFlag(iso) {
              if (!iso) return "üåê";
              const up = iso.toUpperCase();
              return String.fromCodePoint(
                ...[...up].map((c) => 127397 + c.charCodeAt(0))
              );
            }
            function phoneToFlag(phone, defCC) {
              if (!phone) {
                return isoToFlag(CC_TO_ISO[defCC] || "");
              }
              let p = phone.trim();
              if (p.startsWith("+")) {
                p = p.slice(1);
                for (let len of [3, 2, 1]) {
                  const code = p.slice(0, len);
                  if (CC_TO_ISO[code]) return isoToFlag(CC_TO_ISO[code]);
                }
                return "üåê";
              }
              return isoToFlag(CC_TO_ISO[defCC] || "");
            }
            async function saveGeneralSettings() {
              const gym_name = document.getElementById("setGymName").value;
              const currency_code = document.getElementById("setCurrency").value;
              const monthly_price = document.getElementById("setPrice").value;
              const whatsapp_default_country_code =
                document.getElementById("setWaCC").value;
              const res = await fetch("/admin/settings/general", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  gym_name,
                  currency_code,
                  monthly_price,
                  whatsapp_default_country_code,
                }),
              });
              const data = await res.json();
              if (data.ok) {
                showToast("Settings saved successfully", "success");
                setTimeout(() => location.reload(), 1000);
              } else {
                alert("Failed: " + (data.error || "unknown"));
              }
            }
            function updateDefaultFlag() {
              const el = document.getElementById("defaultFlag");
              if (el) el.textContent = isoToFlag(CC_TO_ISO[DEFAULT_CC] || "");
            }
            function updateWaToFlag() {
              const input = document.getElementById("waTo");
              const badge = document.getElementById("waToFlag");
              if (!input || !badge) return;
              badge.textContent = phoneToFlag(input.value, DEFAULT_CC);
            }

            async function uploadLogo() {
              const f = document.getElementById("logoFile").files[0];
              if (!f) {
                showToast("Please select a logo file", "warning");
                return;
              }
              const fd = new FormData();
              fd.append("logo", f);
              const res = await fetch("/admin/settings/logo", {
                method: "POST",
                body: fd,
              });
              const data = await res.json();
              if (data.ok) {
                showToast("Logo uploaded successfully", "success");
                setTimeout(() => location.reload(), 1000);
              } else {
                alert("Upload failed: " + (data.error || "unknown"));
              }
            }
            async function emailBackup() {
              const res = await fetch("/admin/backup/email", { method: "POST" });
              const data = await res.json();
              if (data.ok) {
                showToast("Backup email sent successfully", "success");
              } else {
                alert("Failed: " + (data.error || "unknown error"));
              }
            }

            async function driveBackup() {
              const res = await fetch("/admin/backup/drive", { method: "POST" });
              const data = await res.json();
              if (data.ok) {
                const link =
                  data.file?.webViewLink || data.file?.webContentLink || "";
                showToast("Backup uploaded to Drive successfully" + (link ? " - Link copied to clipboard" : ""), "success");
                if (link) {
                  try { navigator.clipboard.writeText(link); } catch (e) {}
                }
              } else {
                showToast("Drive backup failed: " + (data.error || "unknown error"), "danger");
              }
            }
            // Theme toggle
            (function () {
              const btn = document.getElementById("themeToggle");
              if (!btn) return;
              btn.addEventListener("click", function () {
                const cur =
                  document.documentElement.getAttribute("data-bs-theme") || "dark";
                const next = cur === "dark" ? "light" : "dark";
                document.documentElement.setAttribute("data-bs-theme", next);
                try {
                  localStorage.setItem("theme", next);
                } catch (e) {}
              });
            })();

            async function sendWaTest() {
              const to = document.getElementById("waTo").value;
              const message =
                document.getElementById("waMsg").value || "Test message";
              const res = await fetch("/admin/whatsapp/test", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ to, message }),
              });
              const data = await res.json();
              if (data.ok) showToast("WhatsApp test message sent", "success");
              else showToast("Failed: " + (data.error || "unknown"), "danger");
            }

            async function loadWaStatus() {
              try {
                const res = await fetch("/admin/whatsapp/status");
                const st = await res.json();
                const badge = document.getElementById("waCfgBadge");
                if (st.ok) {
                  badge.className = "badge text-bg-success";
                  badge.textContent = `WhatsApp ready (default +${st.default_country_code})`;
                } else {
                  badge.className = "badge text-bg-danger";
                  badge.textContent = `Missing: ${st.missing.join(", ")}`;
                }
              } catch (e) {
                const badge = document.getElementById("waCfgBadge");
                badge.className = "badge text-bg-warning";
                badge.textContent = "Unable to check WhatsApp status";
              }
            }

            let chart;
            function initYear() {
              const now = new Date();
              document.getElementById("statYear").value = now.getFullYear();
            }
            async function loadStats() {
              const y = document.getElementById("statYear").value;
              const res = await fetch(`/api/stats/monthly?year=${y}`);
              const stats = await res.json();
              const labels = [
                "Jan",
                "Feb",
                "Mar",
                "Apr",
                "May",
                "Jun",
                "Jul",
                "Aug",
                "Sep",
                "Oct",
                "Nov",
                "Dec",
              ];
              const data = {
                labels,
                datasets: [
                  {
                    label: "Paid",
                    data: stats.paid,
                    backgroundColor: "#19875488",
                    borderColor: "#198754",
                    borderWidth: 1,
                  },
                  {
                    label: "Unpaid",
                    data: stats.unpaid,
                    backgroundColor: "#ffc10788",
                    borderColor: "#ffc107",
                    borderWidth: 1,
                  },
                  {
                    label: "N/A",
                    data: stats.na,
                    backgroundColor: "#6c757d55",
                    borderColor: "#6c757d",
                    borderWidth: 1,
                  },
                ],
              };
              const ctx = document.getElementById("feesChart");
              if (chart) {
                chart.destroy();
              }
              chart = new Chart(ctx, {
                type: "bar",
                data,
                options: {
                  responsive: true,
                  plugins: { legend: { position: "bottom" } },
                },
              });
            }
            initYear();
            loadStats();
            loadWaStatus();
            async function loadCollected() {
              try {
                const res = await fetch(`/api/fees/summary`);
                const js = await res.json();
                if (js.ok) {
                  document.getElementById("collectedAmt").textContent = (
                    js.paid_total || 0
                  ).toLocaleString();
                }
              } catch (e) {}
            }
            loadCollected();
            updateDefaultFlag();
            updateWaToFlag();
            document.addEventListener("input", (e) => {
              if (e.target && e.target.id === "waTo") {
                updateWaToFlag();
              }
            });

            // Day View - Load unpaid members for selected date
            async function loadUnpaidForDate() {
              const dateInput = document.getElementById('dayViewDate');
              const resultsDiv = document.getElementById('dayViewResults');
              const dateVal = dateInput.value;
              if (!dateVal) {
                resultsDiv.innerHTML = '<div class="alert alert-warning">Please select a date.</div>';
                return;
              }
              const d = new Date(dateVal);
              const year = d.getFullYear();
              const month = d.getMonth() + 1;
              try {
                resultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Loading...';
                const res = await fetch(`/api/fees/month?year=${year}&month=${month}`);
                const js = await res.json();
                if (!res.ok || !js.ok) {
                  resultsDiv.innerHTML = '<div class="alert alert-danger">Failed to load data.</div>';
                  return;
                }
                const unpaidList = (js.members || []).filter(m => m.status === 'Unpaid');
                if (unpaidList.length === 0) {
                  resultsDiv.innerHTML = '<div class="alert alert-success">No unpaid members for this month.</div>';
                  return;
                }
                let html = `<div class="alert alert-info mb-2">Found ${unpaidList.length} unpaid member(s) for ${month}/${year}</div>`;
                html += '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr>';
                html += '<th>ID</th><th>Name</th><th>Phone</th><th>Amount</th><th>Actions</th></tr></thead><tbody>';
                unpaidList.forEach(m => {
                  html += `<tr>
                    <td>${m.id}</td>
                    <td>${m.name}</td>
                    <td>${m.phone || ''}</td>
                    <td>${m.amount || ''}</td>
                    <td>
                      <button class="btn btn-sm btn-outline-success" onclick="showMemberDetail(${m.id})" title="View Details">
                        <i class="bi bi-eye"></i> View
                      </button>
                      <button class="btn btn-sm btn-outline-primary" onclick="openPayModal(${m.id}, ${year}, ${month}, ${m.amount || 0})" title="Pay Now">
                        <i class="bi bi-cash-coin"></i> Pay
                      </button>
                    </td>
                  </tr>`;
                });
                html += '</tbody></table></div>';
                resultsDiv.innerHTML = html;
              } catch (e) {
                console.error(e);
                resultsDiv.innerHTML = '<div class="alert alert-danger">Error loading unpaid members.</div>';
              }
            }

            // Set today's date as default for day view
            (function() {
              const dateInput = document.getElementById('dayViewDate');
              if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
              }
              // Set current month as default for monthly details
              const monthInput = document.getElementById('monthDetailInput');
              if (monthInput) {
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                monthInput.value = currentMonth;
              }
            })();

            // Monthly Details - Load comprehensive payment info for selected month
            async function loadMonthlyDetails() {
              const monthInput = document.getElementById('monthDetailInput');
              const resultsDiv = document.getElementById('monthlyDetailsResults');
              const monthVal = monthInput.value;
              if (!monthVal) {
                resultsDiv.innerHTML = '<div class="alert alert-warning">Please select a month.</div>';
                return;
              }
              const [year, month] = monthVal.split('-').map(Number);
              try {
                resultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Loading monthly details...';
                const res = await fetch(`/api/fees/month?year=${year}&month=${month}`);
                const js = await res.json();
                if (!res.ok || !js.ok) {
                  resultsDiv.innerHTML = '<div class="alert alert-danger">Failed to load monthly data.</div>';
                  return;
                }
                const members = js.members || [];
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthName = monthNames[month - 1];
                
                // Calculate statistics
                const totalMembers = members.length;
                const paidMembers = members.filter(m => m.status === 'Paid').length;
                const unpaidMembers = members.filter(m => m.status === 'Unpaid').length;
                const naMembers = members.filter(m => m.status === 'N/A').length;
                const totalExpected = members.reduce((sum, m) => sum + (m.amount || 0), 0);
                const totalCollected = members.filter(m => m.status === 'Paid').reduce((sum, m) => sum + (m.amount || 0), 0);
                const totalPending = members.filter(m => m.status === 'Unpaid').reduce((sum, m) => sum + (m.amount || 0), 0);
                const collectionRate = totalMembers > 0 ? ((paidMembers / totalMembers) * 100).toFixed(1) : 0;

                let html = `
                  <div class="card mb-3 border-primary">
                    <div class="card-header bg-primary text-white">
                      <h6 class="mb-0"><i class="bi bi-calendar-month"></i> ${monthName} ${year} - Payment Summary</h6>
                    </div>
                    <div class="card-body">
                      <div class="row g-3">
                        <div class="col-md-3">
                          <div class="text-center p-3 bg-light rounded">
                            <div class="fs-4 fw-bold text-primary">${totalMembers}</div>
                            <div class="small text-muted">Total Members</div>
                          </div>
                        </div>
                        <div class="col-md-3">
                          <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                            <div class="fs-4 fw-bold text-success">${paidMembers}</div>
                            <div class="small text-muted">Paid (${collectionRate}%)</div>
                          </div>
                        </div>
                        <div class="col-md-3">
                          <div class="text-center p-3 bg-danger bg-opacity-10 rounded">
                            <div class="fs-4 fw-bold text-danger">${unpaidMembers}</div>
                            <div class="small text-muted">Unpaid</div>
                          </div>
                        </div>
                        <div class="col-md-3">
                          <div class="text-center p-3 bg-secondary bg-opacity-10 rounded">
                            <div class="fs-4 fw-bold text-secondary">${naMembers}</div>
                            <div class="small text-muted">N/A</div>
                          </div>
                        </div>
                      </div>
                      <hr>
                      <div class="row g-3">
                        <div class="col-md-4">
                          <div class="p-2 border rounded">
                            <div class="small text-muted">Expected</div>
                            <div class="fs-5 fw-bold">${totalExpected.toLocaleString()}</div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="p-2 border border-success rounded">
                            <div class="small text-muted">Collected</div>
                            <div class="fs-5 fw-bold text-success">${totalCollected.toLocaleString()}</div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="p-2 border border-danger rounded">
                            <div class="small text-muted">Pending</div>
                            <div class="fs-5 fw-bold text-danger">${totalPending.toLocaleString()}</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>`;

                // Show members table
                if (members.length > 0) {
                  html += `
                    <ul class="nav nav-tabs" role="tablist">
                      <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#allMembersTab">All (${totalMembers})</button>
                      </li>
                      <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#paidMembersTab">Paid (${paidMembers})</button>
                      </li>
                      <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#unpaidMembersTab">Unpaid (${unpaidMembers})</button>
                      </li>
                    </ul>
                    <div class="tab-content border border-top-0 p-3">
                      <div class="tab-pane fade show active" id="allMembersTab">
                        ${renderMemberTable(members, year, month)}
                      </div>
                      <div class="tab-pane fade" id="paidMembersTab">
                        ${renderMemberTable(members.filter(m => m.status === 'Paid'), year, month)}
                      </div>
                      <div class="tab-pane fade" id="unpaidMembersTab">
                        ${renderMemberTable(members.filter(m => m.status === 'Unpaid'), year, month)}
                      </div>
                    </div>`;
                }
                resultsDiv.innerHTML = html;
                
                // Show action buttons
                const printBtn = document.getElementById('btnPrintMonthly');
                if (printBtn) printBtn.classList.remove('d-none');
                const exportBtn = document.getElementById('btnExportMonthly');
                if (exportBtn) exportBtn.classList.remove('d-none');
                
                // Store members data for export
                window.currentMonthlyData = { members, year, month, monthName };
              } catch (e) {
                console.error(e);
                resultsDiv.innerHTML = '<div class="alert alert-danger">Error loading monthly details. Please try again.</div>';
                // Hide action buttons on error
                const printBtn = document.getElementById('btnPrintMonthly');
                if (printBtn) printBtn.classList.add('d-none');
                const exportBtn = document.getElementById('btnExportMonthly');
                if (exportBtn) exportBtn.classList.add('d-none');
              }
            }

            function exportMonthlyCSV() {
              if (!window.currentMonthlyData) {
                showToast('Please load monthly details first.', 'warning');
                return;
              }
              
              const { members, year, month, monthName } = window.currentMonthlyData;
              
              // Create CSV content
              let csv = 'ID,Name,Phone,Email,Amount,Status\n';
              members.forEach(m => {
                const name = (m.name || '').replace(/,/g, ';');
                const phone = m.phone || '';
                const email = m.email || '';
                const amount = m.amount || 0;
                const status = m.status || '';
                csv += `${m.id},"${name}",${phone},${email},${amount},${status}\n`;
              });
              
              // Create download
              const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
              const link = document.createElement('a');
              const url = URL.createObjectURL(blob);
              link.setAttribute('href', url);
              link.setAttribute('download', `monthly_report_${monthName}_${year}.csv`);
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            }

            function printMonthlyDetails() {
              const resultsDiv = document.getElementById('monthlyDetailsResults');
              if (!resultsDiv || !resultsDiv.innerHTML.includes('Payment Summary')) {
                showToast('Please load monthly details first.', 'warning');
                return;
              }
              
              // Create print window
              const printWindow = window.open('', '_blank');
              const monthInput = document.getElementById('monthDetailInput');
              const selectedMonth = monthInput.value || 'Current Month';
              
              printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                  <title>Monthly Payment Report - ${selectedMonth}</title>
                  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
                  <style>
                    @media print {
                      .no-print { display: none; }
                      body { padding: 20px; }
                      .tab-content .tab-pane { display: block !important; opacity: 1 !important; }
                    }
                    body { font-family: Arial, sans-serif; }
                    .print-header { margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                    .print-date { font-size: 0.9em; color: #666; }
                  </style>
                </head>
                <body>
                  <div class="container">
                    <div class="print-header">
                      <h2 class="text-center mb-2">{{ gym_name }}</h2>
                      <h4 class="text-center">Monthly Payment Report</h4>
                      <p class="text-center print-date">Generated: ${new Date().toLocaleString()}</p>
                    </div>
                    ${resultsDiv.innerHTML}
                  </div>
                  <script>
                    window.onload = function() {
                      // Remove action buttons for printing
                      document.querySelectorAll('button').forEach(btn => btn.remove());
                      // Show all tabs for printing
                      document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.add('show', 'active');
                      });
                      setTimeout(() => { 
                        window.print(); 
                        // Close after printing (optional)
                        setTimeout(() => { window.close(); }, 1000);
                      }, 800);
                    };
                  </script>
                </body>
                </html>
              `);
              printWindow.document.close();
            }

            function renderMemberTable(members, year, month) {
              if (members.length === 0) {
                return '<div class="text-muted">No members in this category.</div>';
              }
              let html = '<div class="table-responsive"><table class="table table-sm table-hover"><thead><tr>';
              html += '<th>ID</th><th>Name</th><th>Phone</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
              members.forEach(m => {
                const statusBadge = m.status === 'Paid' ? 'bg-success' : m.status === 'Unpaid' ? 'bg-danger' : 'bg-secondary';
                html += `<tr>
                  <td>${m.id}</td>
                  <td>${m.name}</td>
                  <td>${m.phone || ''}</td>
                  <td>${m.amount || 0}</td>
                  <td><span class="badge ${statusBadge}">${m.status}</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='/members'" title="View in Members">
                      <i class="bi bi-person"></i>
                    </button>
                    ${m.status === 'Unpaid' ? `
                      <button class="btn btn-sm btn-outline-success" onclick="openPayModal(${m.id}, ${year}, ${month}, ${m.amount || 0})" title="Pay Now">
                        <i class="bi bi-cash-coin"></i> Pay
                      </button>
                    ` : ''}
                  </td>
                </tr>`;
              });
              html += '</tbody></table></div>';
              return html;
            }

            // Onboarding: lightweight 2-step wizard built dynamically
            function buildOnboardModal() {
              const html = `
      <div class="modal fade" id="onboardModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Quick Setup</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="progress progress-sm mb-3">
                <div id="obProg" class="progress-bar w-50"></div>
              </div>
              <div id="obStep1">
                <div class="mb-3">
                  <label class="form-label">Gym Name</label>
                  <input id="obName" class="form-control" placeholder="Your gym name" value="{{ gym_name }}"/>
                </div>
                <div class="row g-2">
                  <div class="col-md-6">
                    <label class="form-label">Currency</label>
                    <input id="obCurrency" class="form-control" placeholder="USD" value="{{ currency_code }}"/>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Monthly Price</label>
                    <input id="obPrice" class="form-control" placeholder="8" value="{{ monthly_price }}"/>
                  </div>
                </div>
              </div>
              <div id="obStep2" class="d-none">
                <div class="mb-2">Features</div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" id="ft_whatsapp" checked>
                  <label class="form-check-label" for="ft_whatsapp">WhatsApp Reminders</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" id="ft_backups" checked>
                  <label class="form-check-label" for="ft_backups">Backups</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" id="ft_pdf" checked>
                  <label class="form-check-label" for="ft_pdf">PDF Cards</label>
                </div>
                <hr/>
                <label class="form-label" for="obLogo">Upload Logo (optional)</label>
                <input id="obLogo" type="file" class="form-control" accept="image/*" aria-label="Upload gym logo"/>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" id="obSkip">Skip</button>
              <div class="ms-auto">
                <button type="button" class="btn btn-secondary" id="obBack" disabled>Back</button>
                <button type="button" class="btn btn-primary" id="obNext">Next</button>
                <button type="button" class="btn btn-success d-none" id="obFinish">Finish</button>
              </div>
            </div>
          </div>
        </div>
      </div>`;
              const div = document.createElement("div");
              div.innerHTML = html;
              document.body.appendChild(div.firstElementChild);
            }
            let obStep = 1;
            function obSetStep(n) {
              obStep = n;
              document.getElementById("obStep1").classList.toggle("d-none", n !== 1);
              document.getElementById("obStep2").classList.toggle("d-none", n !== 2);
              document.getElementById("obBack").disabled = n === 1;
              document.getElementById("obNext").classList.toggle("d-none", n === 2);
              document.getElementById("obFinish").classList.toggle("d-none", n !== 2);
              const prog = document.getElementById("obProg");
              prog.style.width = n * 50 + "%";
            }
            function setLoading(btn, loading, label){
              if (!btn) return;
              if (loading){
                btn.disabled = true;
                btn.dataset.label = btn.innerHTML;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>' + (label || 'Working‚Ä¶');
              } else {
                btn.disabled = false;
                if (btn.dataset.label) btn.innerHTML = btn.dataset.label;
              }
            }

            async function obSaveLogo() {
              const f = document.getElementById("obLogo")?.files?.[0];
              if (!f) return;
              const fd = new FormData();
              fd.append("logo", f);
              await fetch("/onboarding/logo", { method: "POST", body: fd });
            }
            async function obFinish() {
              const features = [];
              if (document.getElementById("ft_whatsapp").checked)
                features.push("whatsapp");
              if (document.getElementById("ft_backups").checked)
                features.push("backups");
              if (document.getElementById("ft_pdf").checked) features.push("pdf");
              await obSaveLogo();
              const payload = {
                gym_name: document.getElementById("obName").value,
                currency_code: document.getElementById("obCurrency").value,
                monthly_price: document.getElementById("obPrice").value,
                features,
              };
              const res = await fetch("/onboarding/complete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              if (res.ok) {
                location.reload();
              }
            }
            function downloadBackup(){
              // Simple navigation to GET endpoint triggers browser download
              window.location.href = '/admin/backup/download';
            }
            // Monthly Reminders
            async function loadReminderSettings(){
              try{
                const res = await fetch('/admin/settings/reminders');
                const data = await res.json();
                if(data.ok){
                  document.getElementById('reminderEnabled').checked = data.enabled;
                  document.getElementById('reminderHour').value = data.hour;
                  document.getElementById('reminderMinute').value = data.minute;
                  const status = document.getElementById('reminderStatus');
                  if(data.enabled){
                    status.className = 'badge text-bg-success';
                    status.textContent = `Enabled - Daily at ${String(data.hour).padStart(2,'0')}:${String(data.minute).padStart(2,'0')}`;
                  } else {
                    status.className = 'badge text-bg-secondary';
                    status.textContent = 'Disabled';
                  }
                }
              } catch(e){
                document.getElementById('reminderStatus').textContent = 'Error loading settings';
              }
            }
            async function saveReminderSettings(){
              const enabled = document.getElementById('reminderEnabled').checked;
              const hour = parseInt(document.getElementById('reminderHour').value || '9');
              const minute = parseInt(document.getElementById('reminderMinute').value || '0');
              try{
                const res = await fetch('/admin/settings/reminders', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ enabled, hour, minute })
                });
                const data = await res.json();
                if(data.ok){
                  showToast(data.message || 'Reminder settings saved', 'success');
                  loadReminderSettings();
                } else {
                  showToast('Failed to save: ' + (data.error || 'unknown'), 'danger');
                }
              } catch(e){
                showToast('Error saving reminder settings', 'danger');
              }
            }
            async function sendRemindersNow(){
              if(!confirm('Send fee reminders to all unpaid members for this month?')) return;
              try{
                const res = await fetch('/admin/schedule/run-now', { method: 'POST' });
                const data = await res.json();
                if(data.ok){
                  showToast(`Reminders sent: ${data.sent || 0} success, ${data.failed || 0} failed`, 'success');
                } else {
                  showToast('Failed: ' + (data.error || 'unknown'), 'danger');
                }
              } catch(e){
                showToast('Error sending reminders', 'danger');
              }
            }
            // Backup Management Functions
            async function createBackup(){
              const btn = document.getElementById('btnCreateBackup');
              if(btn) btn.disabled = true;
              showToast('Creating backup...', 'info');
              try{
                const res = await fetch('/api/backup/create', { method: 'POST' });
                const data = await res.json();
                if(data.ok){
                  showToast('Backup created successfully!', 'success');
                  if(typeof refreshBackupList === 'function') refreshBackupList();
                } else {
                  showToast('Backup failed: ' + (data.error || 'unknown'), 'danger');
                }
              } catch(e){
                showToast('Error creating backup', 'danger');
              } finally {
                if(btn) btn.disabled = false;
              }
            }

            async function downloadBackup(){
              showToast('Preparing backup download...', 'info');
              try{
                window.location.href = '/api/backup/download';
                setTimeout(() => showToast('Backup downloaded!', 'success'), 500);
              } catch(e){
                showToast('Error downloading backup', 'danger');
              }
            }

            async function refreshBackupList(){
              const statusEl = document.getElementById('backupListStatus');
              const tableContainer = document.getElementById('backupTableContainer');
              const tbody = document.getElementById('backupTableBody');
              const countEl = document.getElementById('backupCount');
              const sizeEl = document.getElementById('backupSize');
              
              statusEl.style.display = 'block';
              statusEl.className = 'alert alert-info';
              statusEl.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading backups...';
              tableContainer.style.display = 'none';
              
              try{
                const res = await fetch('/api/backup/list');
                const data = await res.json();
                
                if(data.ok && data.backups.length > 0){
                  tbody.innerHTML = '';
                  data.backups.forEach(backup => {
                    const row = tbody.insertRow();
                    const sizeKB = (backup.size / 1024).toFixed(2);
                    const sizeMB = (backup.size / 1024 / 1024).toFixed(2);
                    const sizeDisplay = backup.size > 1024*1024 ? sizeMB + ' MB' : sizeKB + ' KB';
                    const created = new Date(backup.created).toLocaleString();
                    
                    row.innerHTML = `
                      <td><code>${backup.filename}</code></td>
                      <td>${created}</td>
                      <td>${sizeDisplay}</td>
                      <td>
                        <button class="btn btn-sm btn-success" onclick="downloadSpecificBackup('${backup.filename}')" title="Download">
                          <i class="bi bi-download"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="restoreBackup('${backup.filename}')" title="Restore">
                          <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBackup('${backup.filename}')" title="Delete">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    `;
                  });
                  
                  const totalMB = (data.total_size / 1024 / 1024).toFixed(2);
                  countEl.textContent = data.total + ' backup' + (data.total !== 1 ? 's' : '');
                  sizeEl.textContent = totalMB + ' MB';
                  
                  statusEl.style.display = 'none';
                  tableContainer.style.display = 'block';
                } else {
                  statusEl.className = 'alert alert-warning';
                  statusEl.innerHTML = '<i class="bi bi-info-circle"></i> No backups found. Create your first backup!';
                  tableContainer.style.display = 'none';
                }
              } catch(e){
                statusEl.className = 'alert alert-danger';
                statusEl.innerHTML = '<i class="bi bi-x-circle"></i> Error loading backups: ' + e.message;
              }
            }

            async function downloadSpecificBackup(filename){
              window.location.href = '/admin/backup/download/' + filename;
            }

            async function restoreBackup(filename){
              if(!confirm(`Restore backup: ${filename}?\n\nThis will replace your current data. The app will need to restart.`)) return;
              showToast('Restoring backup...', 'info');
              try{
                const res = await fetch('/admin/backup/restore/' + filename, { method: 'POST' });
                const data = await res.json();
                if(data.ok){
                  showToast('Backup restored! Please restart the application.', 'success');
                  refreshBackupList();
                } else {
                  showToast('Restore failed: ' + (data.error || 'unknown'), 'danger');
                }
              } catch(e){
                showToast('Error restoring backup', 'danger');
              }
            }

            async function deleteBackup(filename){
              if(!confirm(`Delete backup: ${filename}?\n\nThis cannot be undone.`)) return;
              try{
                const res = await fetch('/admin/backup/delete/' + filename, { method: 'DELETE' });
                const data = await res.json();
                if(data.ok){
                  showToast('Backup deleted', 'success');
                  refreshBackupList();
                } else {
                  showToast('Delete failed: ' + (data.error || 'unknown'), 'danger');
                }
              } catch(e){
                showToast('Error deleting backup', 'danger');
              }
            }

            // Auto-load backups when modal is opened
            document.addEventListener('DOMContentLoaded', function(){
              const backupModal = document.getElementById('backupManagerModal');
              if(backupModal){
                backupModal.addEventListener('show.bs.modal', function(){
                  refreshBackupList();
                });
              }
            });

            function confirmSystemReset(){
              const modalEl = document.getElementById('systemResetModal');
              if (modalEl && window.bootstrap){
                const modalInstance = new bootstrap.Modal(modalEl);
                modalInstance.show();
                const confirmInput = document.getElementById('resetConfirmInput');
                if(confirmInput){
                  confirmInput.value = '';
                  setTimeout(()=>confirmInput.focus(), 200);
                }
                const statusEl = document.getElementById('resetStatus');
                if(statusEl) statusEl.textContent = '';
              }
            }
            // System Reset: open modal and perform POST /admin/system/reset with confirmation
            (function(){
              const btn = document.getElementById('btnSystemReset');
              const modalEl = document.getElementById('systemResetModal');
              const confirmInput = document.getElementById('resetConfirmInput');
              const statusEl = document.getElementById('resetStatus');
              const confirmBtn = document.getElementById('confirmSystemResetBtn');
              let modalInstance = null;
              if (window.bootstrap && modalEl){
                modalInstance = new bootstrap.Modal(modalEl);
              }
              if (btn && modalInstance){
                btn.addEventListener('click', function(){
                  statusEl.textContent = '';
                  confirmInput.value = '';
                  modalInstance.show();
                  setTimeout(()=>confirmInput.focus(), 200);
                });
              }
              async function performReset(){
                const txt = (confirmInput.value || '').trim();
                if (txt !== 'RESET'){
                  statusEl.textContent = 'Please type RESET to confirm.';
                  statusEl.className = 'text-danger';
                  return;
                }
                statusEl.textContent = 'Resetting system...';
                statusEl.className = 'text-warning';
                try{
                  const resp = await fetch('/api/system/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirm: 'RESET' })
                  });
                  let data = null;
                  try { data = await resp.json(); } catch {}
                  if (resp.ok && data && data.ok){
                    statusEl.textContent = 'System reset completed successfully.';
                    statusEl.className = 'text-success';
                    setTimeout(()=>{ modalInstance.hide(); window.location.reload(); }, 800);
                  } else {
                    const msg = data && data.error ? data.error : `HTTP ${resp.status}`;
                    statusEl.textContent = 'Reset failed: ' + msg;
                    statusEl.className = 'text-danger';
                  }
                } catch(e){
                  statusEl.textContent = 'Network error during reset.';
                  statusEl.className = 'text-danger';
                }
              }
              if (confirmBtn){
                confirmBtn.addEventListener('click', performReset);
              }
            })();
            async function checkOnboarding() {
              try {
                const r = await fetch("/onboarding/status");
                const js = await r.json();
                if (js.ok && js.needed) {
                  buildOnboardModal();
                  const m = new bootstrap.Modal(
                    document.getElementById("onboardModal"),
                    { backdrop: "static", keyboard: false }
                  );
                  document
                    .getElementById("obSkip")
                    .addEventListener("click", async () => {
                      await fetch("/onboarding/complete", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ skip: true }),
                      });
                      location.reload();
                    });
                  document
                    .getElementById("obNext")
                    .addEventListener("click", () =>
                      obSetStep(Math.min(2, obStep + 1))
                    );
                  document
                    .getElementById("obBack")
                    .addEventListener("click", () =>
                      obSetStep(Math.max(1, obStep - 1))
                    );
                  document
                    .getElementById("obFinish")
                    .addEventListener("click", obFinish);
                  m.show();
                }
              } catch (e) {}
            }
            checkOnboarding();
            loadReminderSettings();
            
            // Monthly Fees Analysis
            let currentMonthlyFeesModal = null;
            let memberDetailModal = null;
            
            document.addEventListener('DOMContentLoaded', function(){
              const modalEl = document.getElementById('monthlyFeesModal');
              const memberModalEl = document.getElementById('memberDetailModal');
              if(modalEl) currentMonthlyFeesModal = new bootstrap.Modal(modalEl);
              if(memberModalEl) memberDetailModal = new bootstrap.Modal(memberModalEl);
              
              modalEl?.addEventListener('shown.bs.modal', function(){
                loadCurrentMonthFees();
                loadUnpaidMembers();
                initHistorySelectors();
              });
            });
            
            async function loadCurrentMonthFees(){
              const now = new Date();
              const year = now.getFullYear();
              const month = now.getMonth() + 1;
              try{
                const res = await fetch(`/api/fees/month?year=${year}&month=${month}`);
                const data = await res.json();
                if(data.ok){
                  document.getElementById('currentPaid').textContent = data.paid_count || 0;
                  document.getElementById('currentUnpaid').textContent = data.unpaid_count || 0;
                  document.getElementById('currentCollected').textContent = `${(data.collected || 0).toLocaleString()} ${data.currency || 'PKR'}`;
                  
                  const tbody = document.getElementById('currentMembersTable');
                  if(data.members && data.members.length > 0){
                    tbody.innerHTML = data.members.map(m => `
                      <tr>
                        <td>${m.name}</td>
                        <td>${m.phone || '-'}</td>
                        <td><span class="badge text-bg-${m.status === 'Paid' ? 'success' : 'warning'}">${m.status}</span></td>
                        <td>${m.amount ? m.amount.toLocaleString() : '-'} ${data.currency || 'PKR'}</td>
                        <td>
                          <button class="btn btn-sm btn-outline-info" onclick="showMemberDetail(${m.member_id})">View</button>
                          ${m.status === 'Unpaid' ? 
                            `<button class=\"btn btn-sm btn-success ms-1\" onclick=\"openPayModal(${m.member_id}, ${year}, ${month})\"><i class=\"bi bi-cash-coin\"></i> Pay & Slip</button>` :
                            `<a class=\"btn btn-sm btn-outline-secondary ms-1\" target=\"_blank\" href=\"/receipt/member/${m.member_id}/${year}/${month}\"><i class=\"bi bi-receipt\"></i> Slip</a>`
                          }
                        </td>
                      </tr>
                    `).join('');
                  } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No data</td></tr>';
                  }
                }
              } catch(e){
                console.error(e);
              }
            }
            
            function initHistorySelectors(){
              const now = new Date();
              document.getElementById('historyMonth').value = now.getMonth() + 1;
              document.getElementById('historyYear').value = now.getFullYear();
            }
            
            async function loadHistoryMonth(){
              const month = document.getElementById('historyMonth').value;
              const year = document.getElementById('historyYear').value;
              try{
                const res = await fetch(`/api/fees/month?year=${year}&month=${month}`);
                const data = await res.json();
                const tbody = document.getElementById('historyTable');
                if(data.ok && data.members && data.members.length > 0){
                  tbody.innerHTML = data.members.map(m => `
                    <tr>
                      <td>${m.name}</td>
                      <td><span class="badge text-bg-${m.status === 'Paid' ? 'success' : m.status === 'Unpaid' ? 'warning' : 'secondary'}">${m.status}</span></td>
                      <td>${m.amount ? m.amount.toLocaleString() : '-'} ${data.currency || 'PKR'}</td>
                      <td>${m.paid_date || '-'}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-info" onclick="showMemberDetail(${m.member_id})">View</button>
                        ${m.status === 'Unpaid' ? 
                          `<button class=\"btn btn-sm btn-success ms-1\" onclick=\"openPayModal(${m.member_id}, ${year}, ${month})\"><i class=\"bi bi-cash-coin\"></i> Pay & Slip</button>` :
                          `<a class=\"btn btn-sm btn-outline-secondary ms-1\" target=\"_blank\" href=\"/receipt/member/${m.member_id}/${year}/${month}\"><i class=\"bi bi-receipt\"></i> Slip</a>`
                        }
                      </td>
                    </tr>
                  `).join('');
                } else {
                  tbody.innerHTML = '<tr><td colspan="5" class="text-center">No data for this month</td></tr>';
                }
              } catch(e){
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>';
              }
            }
            
            async function loadUnpaidMembers(){
              try{
                const res = await fetch('/api/fees/unpaid-summary');
                const data = await res.json();
                const tbody = document.getElementById('unpaidTable');
                if(data.ok && data.members && data.members.length > 0){
                  tbody.innerHTML = data.members.map(m => `
                    <tr>
                      <td>${m.name}</td>
                      <td>${m.phone || '-'}</td>
                      <td><span class="badge text-bg-${m.last_paid_month ? 'info' : 'secondary'}">${m.last_paid_month || 'Never'}</span></td>
                      <td><span class="badge text-bg-warning">${m.months_unpaid || 0}</span></td>
                      <td class="text-danger fw-bold">${(m.total_due || 0).toLocaleString()} PKR</td>
                      <td>
                        <button class="btn btn-sm btn-outline-info" onclick="showMemberDetail(${m.id})">View</button>
                        <button class="btn btn-sm btn-success ms-1" onclick="openPayModal(${m.id}, (new Date()).getFullYear(), (new Date()).getMonth()+1)"><i class="bi bi-cash-coin"></i> Pay This Month</button>
                      </td>
                    </tr>
                  `).join('');
                } else {
                  tbody.innerHTML = '<tr><td colspan="6" class="text-center">No unpaid members</td></tr>';
                }
              } catch(e){
                console.error(e);
              }
            }

            async function payFor(memberId, year, month){
              try{
                if(!memberId || !year || !month){
                  showToast('Missing details for payment', 'danger');
                  return;
                }
                if(!confirm(`Mark paid for ${month}/${year}? A receipt will open.`)) return;
                const payload = { member_id: parseInt(memberId), year: parseInt(year), month: parseInt(month) };
                const res = await fetch('/api/payment/pay-now', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
                let data = null;
                try { data = await res.json(); } catch {}
                if(res.ok && data && data.ok){
                  showToast('Payment recorded. Opening receipt‚Ä¶', 'success');
                  const url = data.receipt_url || `/receipt/member/${memberId}/${year}/${month}`;
                  window.open(url, '_blank');
                  // Refresh views
                  loadCurrentMonthFees();
                  const hm = parseInt(document.getElementById('historyMonth')?.value || '0');
                  const hy = parseInt(document.getElementById('historyYear')?.value || '0');
                  if(hm === parseInt(month) && hy === parseInt(year)){
                    loadHistoryMonth();
                  }
                  loadUnpaidMembers();
                } else {
                  const msg = data && data.error ? data.error : `HTTP ${res.status}`;
                  showToast('Payment failed: ' + msg, 'danger');
                }
              } catch(e){
                showToast('Error processing payment', 'danger');
              }
            }

            // Compatibility wrapper for older UI calls
            function markPaid(memberId, month, year){
              // match original signature (memberId, month, year)
              return payFor(memberId, year, month);
            }

            // Open Pay modal with context
            let payModalInstance;
            function openPayModal(memberId, year, month, amount){
              const modalEl = document.getElementById('payModal');
              if(!payModalInstance){
                payModalInstance = new bootstrap.Modal(modalEl);
              }
              const btn = document.getElementById('payConfirmBtn');
              btn.dataset.memberId = String(memberId);
              btn.dataset.year = String(year);
              btn.dataset.month = String(month);
              document.getElementById('payMethod').value = 'cash';
              const amtEl = document.getElementById('payAmount');
              amtEl.value = amount != null && amount !== '' ? String(amount) : '';
              payModalInstance.show();
            }

            // Handle confirm from Pay modal
            (function(){
              const btn = document.getElementById('payConfirmBtn');
              if(!btn) return;
              btn.addEventListener('click', async function(){
                const memberId = parseInt(this.dataset.memberId || '0');
                const year = parseInt(this.dataset.year || '0');
                const month = parseInt(this.dataset.month || '0');
                const method = (document.getElementById('payMethod').value || 'cash');
                const amtStr = document.getElementById('payAmount').value;
                const amount = amtStr.trim() === '' ? undefined : parseFloat(amtStr);
                if(!memberId || !year || !month){
                  showToast('Missing details for payment', 'danger');
                  return;
                }
                try{
                  setLoading(btn, true, 'Processing‚Ä¶');
                  const payload = { member_id: memberId, year, month, method };
                  if(typeof amount === 'number' && !Number.isNaN(amount)) payload.amount = amount;
                  const res = await fetch('/api/payment/pay-now', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                  });
                  let data = null;
                  try { data = await res.json(); } catch {}
                  if(res.ok && data && data.ok){
                    showToast('Payment recorded. Opening receipt‚Ä¶', 'success');
                    const url = data.receipt_url || `/receipt/member/${memberId}/${year}/${month}`;
                    try { payModalInstance?.hide(); } catch {}
                    window.open(url, '_blank');
                    loadCurrentMonthFees();
                    const hm = parseInt(document.getElementById('historyMonth')?.value || '0');
                    const hy = parseInt(document.getElementById('historyYear')?.value || '0');
                    if(hm === parseInt(month) && hy === parseInt(year)){
                      loadHistoryMonth();
                    }
                    loadUnpaidMembers();
                  } else {
                    const msg = data && data.error ? data.error : `HTTP ${res.status}`;
                    showToast('Payment failed: ' + msg, 'danger');
                  }
                } catch(e){
                  showToast('Error processing payment', 'danger');
                } finally {
                  setLoading(btn, false);
                }
              });
            })();
            
            async function showMemberDetail(memberId){
                try {
                  const res = await fetch('/api/member/' + memberId + '/payment-history');
                  const data = await res.json();
                  let m = null;
                  if (data.ok) {
                    m = data.member;
                    window.currentMemberId = memberId;
                    // Personal Information
                    document.getElementById('detailName').textContent = m.name || '-';
                    document.getElementById('detailPhone').textContent = m.phone || '-';
                    document.getElementById('detailEmail').textContent = m.email || '-';
                    document.getElementById('detailCNIC').textContent = m.cnic || '-';
                    document.getElementById('detailAddress').textContent = m.address || '-';
                    document.getElementById('detailGender').textContent = m.gender || '-';
                    document.getElementById('detailDOB').textContent = m.date_of_birth || '-';
                    // Membership Details
                    document.getElementById('detailAdmission').textContent = m.admission_date || '-';
                    document.getElementById('detailMonthlyFee').textContent = m.monthly_price ? ((data.currency || 'PKR') + ' ' + m.monthly_price.toLocaleString()) : '-';
                    document.getElementById('detailReferred').textContent = m.referred_by || '-';
                    document.getElementById('detailStatus').innerHTML = m.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>';
                    document.getElementById('detailNotes').textContent = m.notes || 'No notes';
                    // Payment Statistics
                    var paidPayments = data.payments.filter(function(p){return p.status === 'Paid';});
                    var unpaidPayments = data.payments.filter(function(p){return p.status === 'Unpaid';});
                    var totalPaid = paidPayments.reduce(function(sum, p){return sum + (p.amount || 0);}, 0);
                    var totalDue = unpaidPayments.length * (m.monthly_price || 0);
                  document.getElementById('detailTotalPaid').textContent = (data.currency || 'PKR') + ' ' + totalPaid.toLocaleString();
                  document.getElementById('detailTotalDue').textContent = (data.currency || 'PKR') + ' ' + totalDue.toLocaleString();
                  document.getElementById('memberLastPaid').textContent = data.last_paid_month || 'Never paid';
                  document.getElementById('memberUnpaidCount').textContent = data.months_unpaid || 0;
                  // Payment Timeline
                  var timeline = document.getElementById('memberTimeline');
                  if (data.payments && data.payments.length > 0) {
                    var html = '';
                    // Admission month highlight
                    var admissionMonth = null;
                    var admissionPaid = false;
                    var admissionPayment = null;
                    if (m.admission_date) {
                      var ad = new Date(m.admission_date);
                      var adMonth = ad.getMonth() + 1;
                      var adYear = ad.getFullYear();
                      for (var i = 0; i < data.payments.length; i++) {
                        var p = data.payments[i];
                        if (p.month === adMonth && p.year === adYear) {
                          admissionMonth = p;
                          admissionPaid = (p.status === 'Paid');
                          admissionPayment = p;
                          break;
                        }
                      }
                    }
                    var admissionStatusDiv = document.getElementById('admissionMonthPaidStatus');
                    if (admissionMonth) {
                      var badgeClass = admissionPaid ? 'bg-success' : 'bg-danger';
                      var badgeText = admissionPaid ? 'Paid' : 'Unpaid';
                      var remainderTag = '';
                      if (!admissionPaid) {
                        remainderTag = '<span class="badge bg-warning text-dark ms-2">Remainder Fee</span>';
                      }
                      var btn = '';
                      if (!admissionPaid) {
                        btn = '<button class="btn btn-sm btn-outline-success ms-3" onclick="markFeePaid(' + memberId + ',' + admissionMonth.month + ',' + admissionMonth.year + ',' + '\'Paid\'' + ')">Mark Paid</button>';
                      }
                      admissionStatusDiv.innerHTML = '<span class="badge ' + badgeClass + ' fs-5 px-4 py-2">Admission Month: ' + admissionMonth.month_name + ' ' + admissionMonth.year + ' - ' + badgeText + '</span>' + remainderTag + btn;
                    } else {
                      admissionStatusDiv.innerHTML = '';
                    }
                    for (var i = 0; i < data.payments.length; i++) {
                      var p = data.payments[i];
                      var badgeClass = 'bg-secondary';
                      var textClass = 'text-light';
                      if (p.status === 'Paid') { badgeClass = 'bg-success'; textClass = 'text-white'; }
                      else if (p.status === 'Unpaid') { badgeClass = 'bg-danger'; textClass = 'text-white'; }
                      html += '<div class="list-group-item list-group-item-action bg-dark border-secondary py-3">';
                      html += '<div class="d-flex w-100 justify-content-between align-items-center">';
                      html += '<h6 class="mb-1">' + p.month_name + ' ' + p.year + '</h6>';
                      html += '<span class="badge ' + badgeClass + ' ' + textClass + ' fs-5 px-4 py-2">' + p.status + '</span>';
                      html += '<button class="btn btn-sm ms-3 ' + (p.status === 'Paid' ? 'btn-outline-danger' : 'btn-outline-success') + '" onclick="markFeePaid(' + memberId + ',' + p.month + ',' + p.year + ',' + (p.status === 'Paid' ? '\'Unpaid\'' : '\'Paid\'') + ')">' + (p.status === 'Paid' ? 'Mark Unpaid' : 'Mark Paid') + '</button>';
                      html += '</div>';
                      html += '<p class="mb-1">Amount: <strong>' + (p.amount ? p.amount.toLocaleString() : '-') + ' ' + (data.currency || 'PKR') + '</strong></p>';
                      if (p.paid_date) html += '<small class="text-muted">Paid on: ' + p.paid_date + '</small>';
                      html += '</div>';
                    }
                    timeline.innerHTML = html;
                  } else {
                    timeline.innerHTML = '<div class="text-center py-3">No payment history</div>';
                  }
                } else {
                  // Error: member not found or backend error
                  document.getElementById('detailName').textContent = '-';
                  document.getElementById('detailPhone').textContent = '-';
                  document.getElementById('detailEmail').textContent = '-';
                  document.getElementById('detailCNIC').textContent = '-';
                  document.getElementById('detailAddress').textContent = '-';
                  document.getElementById('detailGender').textContent = '-';
                  document.getElementById('detailDOB').textContent = '-';
                  document.getElementById('detailAdmission').textContent = '-';
                  document.getElementById('detailMonthlyFee').textContent = '-';
                  document.getElementById('detailReferred').textContent = '-';
                  document.getElementById('detailStatus').innerHTML = '<span class="badge bg-danger">Error</span>';
                  document.getElementById('detailNotes').textContent = 'Unable to load member details.';
                  document.getElementById('detailTotalPaid').textContent = '-';
                  document.getElementById('detailTotalDue').textContent = '-';
                  document.getElementById('memberLastPaid').textContent = '-';
                  document.getElementById('memberUnpaidCount').textContent = '-';
                  document.getElementById('memberTimeline').innerHTML = '<div class="text-center text-danger">Error loading member details. Member may not exist.</div>';
                }
                // Always show the modal
          if (typeof memberDetailModal !== 'undefined' && memberDetailModal && typeof memberDetailModal.show === 'function') {
            memberDetailModal.show();
          } else {
            var modal = new bootstrap.Modal(document.getElementById('memberDetailModal'));
            modal.show();
          }
        } catch(e){
          // Handle fetch or other errors
          document.getElementById('memberTimeline').innerHTML = '<div class="text-center text-danger">Error loading member details. Member may not exist.</div>';
        }
      }
    </script>
    <script>
      // Register Service Worker for Offline Support
      /*
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("/static/service-worker.js")
          .then((registration) => {
            console.log(
              "Service Worker registered successfully:",
              registration.scope
            );
          })
          .catch((error) => {
            console.log("Service Worker registration failed:", error);
          });
      });
      */
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
