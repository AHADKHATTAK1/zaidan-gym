<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - {{ gym_name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/static/css/theme.css" />
  <script>
  async function loadOnboarding() {
    try {
      const r = await fetch("/onboarding/status");
      const j = await r.json();
      if (j.needed) {
        document.getElementById("onboarding").style.display = "";
        document.getElementById("ob_gym_name").value =
          j.settings.gym_name || "";
        document.getElementById("ob_purpose").value =
          j.settings.gym_purpose || "";
        document.getElementById("ob_currency").value =
          j.settings.currency_code || "USD";
        document.getElementById("ob_price").value =
          j.settings.monthly_price || "8";
      }
    } catch {}
  }

  async function saveOnboarding() {
    const name = document.getElementById("ob_gym_name").value.trim();
    const purpose = document.getElementById("ob_purpose").value.trim();
    const currency = document.getElementById("ob_currency").value;
    const price = document.getElementById("ob_price").value;
    // features
    const checks = Array.from(
      document.querySelectorAll("#onboarding input[type=checkbox]:checked")
    ).map((x) => x.value);
    // optional logo
    const fileEl = document.getElementById("ob_logo");
    const file = fileEl.files && fileEl.files[0];
    if (file) {
      const fd = new FormData();
      fd.append("logo", file);
      await fetch("/onboarding/logo", { method: "POST", body: fd });
    }
    await fetch("/onboarding/complete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        gym_name: name,
        gym_purpose: purpose,
        currency_code: currency,
        monthly_price: price,
        features: checks,
      }),
    });
    location.reload();
  }

  async function skipOnboarding() {
    await fetch("/onboarding/complete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    });
    location.reload();
  }

  // Call onboarding loader on page load
  window.addEventListener('DOMContentLoaded', loadOnboarding);
  </script>
{% if google_ready %}
<script>
  // Optionally, you can auto-focus the username field when Google is ready
  document.querySelector('input[name="username"]')?.focus();
</script>
{% endif %}
<script>
  window.handleCredentialResponse = async function(resp){
    try{
      const r = await fetch('/auth/google/verify', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({credential: resp.credential})
      });
      const j = await r.json();
      if (j.ok){
        window.location.href = '/dashboard';
      } else {
        showToast('Google sign-in failed: ' + (j.error || 'unknown'), 'danger');
      }
    } catch(e){
      showToast('Google sign-in error', 'danger');
    }
  }
</script>

</head>
<body class="p-4">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-5">
        <div class="card shadow-sm">
          <div class="card-body">
            <h3 class="card-title mb-3">Welcome to {{ gym_name }}</h3>
            <p class="text-muted mb-4">Please sign in to continue.</p>
            <form method="post" class="vstack gap-2 mb-3" aria-label="Local login form">
              <div>
                <label class="form-label" for="username">Username</label>
                <input class="form-control" id="username" name="username" placeholder="Enter username" required />
              </div>
              <div>
                <label class="form-label" for="password">Password</label>
                <input class="form-control" id="password" type="password" name="password" placeholder="Enter password" required />
              </div>
              <button class="btn btn-primary" type="submit">Sign In</button>
            </form>
            <div class="d-grid gap-2 mb-3">
              <a class="btn btn-success" href="/login/google">
                <i class="bi bi-google"></i> Continue with Google
              </a>
            </div>
            <hr />
            <div id="onboarding" class="mt-3 d-none">
              <h5>Quick Setup</h5>
              <div class="vstack gap-2">
                <input id="ob_gym_name" class="form-control" placeholder="Gym Name" />
                <input id="ob_purpose" class="form-control" placeholder="Purpose (e.g., Fitness Center)" />
                <div class="row g-2">
                  <div class="col-md-6">
                    <label class="form-label" for="ob_currency">Currency</label>
                    <select id=lo"ob_currency" class="form-select" aria-label="Select currency" title="Currency">
                      <option value="USD">USD</option>
                      <option value="PKR">PKR</option>s
                      <option value="EUR">EUR</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label" for="ob_price">Monthly Price</label>
                    <input id="ob_price" type="number" step="0.01" class="form-control" placeholder="Monthly Price" aria-label="Monthly Price" title="Monthly Price" />
                  </div>
                </div>
                <div>
                  <label class="form-label">Logo (optional)</label>
                  <input id="ob_logo" type="file" class="form-control" accept="image/*" title="Upload gym logo (optional)" placeholder="Upload gym logo (optional)" />
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="feat_reminders" value="reminders" />
                  <label class="form-check-label" for="feat_reminders">Enable WhatsApp reminders</label>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-primary" type="button" onclick="saveOnboarding()">Save</button>
                  <button class="btn btn-outline-secondary" type="button" onclick="skipOnboarding()">Skip</button>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification Container -->
  <div id="toastArea" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Toast notification function
    function showToast(message, type) {
      try {
        const area = document.getElementById('toastArea');
        const level = (type || 'success').toLowerCase();
        const cls = level === 'success' ? 'text-bg-success' : level === 'warning' ? 'text-bg-warning' : level === 'info' ? 'text-bg-info' : 'text-bg-danger';
        const el = document.createElement('div');
        el.className = `toast align-items-center ${cls} border-0`;
        el.setAttribute('role', 'alert');
        el.setAttribute('aria-live', 'assertive');
        el.setAttribute('aria-atomic', 'true');
        el.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
        area.appendChild(el);
        const t = new bootstrap.Toast(el, { delay: 3500 });
        t.show();
        el.addEventListener('hidden.bs.toast', () => el.remove());
      } catch (e) {
        alert(message);
      }
    }
  </script>
</body>
</html>
