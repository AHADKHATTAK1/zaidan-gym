<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login - {{ gym_name }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    {% if google_ready %}
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    {% endif %}
    <link rel="stylesheet" href="/static/css/theme.css" />
    <style>
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(
            circle at top right,
            rgba(0, 196, 108, 0.25),
            transparent 45%
          ),
          radial-gradient(
            circle at 20% 20%,
            rgba(9, 132, 227, 0.3),
            transparent 35%
          ),
          linear-gradient(
            135deg,
            var(--white),
            var(--light-grey) 60%,
            var(--white)
          );
      }
      .login-shell {
        width: min(460px, 92vw);
        padding: 2.5rem;
        border-radius: 32px;
        background: rgba(241, 242, 246, 0.85);
        border: 1px solid var(--border-grey);
        box-shadow: 0 25px 55px rgba(45, 52, 54, 0.15);
        backdrop-filter: blur(28px) saturate(140%);
      }
      .brand-mark {
        font-size: 1.35rem;
        font-weight: 700;
        letter-spacing: 0.4px;
        background: linear-gradient(120deg, var(--emerald), var(--deep-green));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }
      .form-label {
        font-weight: 600;
      }
      .form-control,
      .btn-custom {
        border-radius: 14px;
        font-size: 0.95rem;
      }
      .form-control {
        background: var(--white);
        border: 1px solid var(--border-grey);
      }
      .form-control:focus {
        border-color: var(--emerald);
        box-shadow: 0 0 0 0.2rem rgba(0, 196, 108, 0.2);
      }
      .btn-custom {
        background: linear-gradient(135deg, var(--deep-green), var(--emerald));
        border: none;
        color: var(--white);
        font-weight: 600;
        box-shadow: 0 15px 25px rgba(0, 196, 108, 0.35);
      }
      .btn-google {
        border-radius: 14px;
        border: 1px solid var(--border-grey);
        background: var(--white);
        color: var(--charcoal);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.65rem;
        justify-content: center;
      }
      .btn-google img {
        width: 20px;
      }
      .divider {
        display: flex;
        align-items: center;
        gap: 0.85rem;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.35rem;
        opacity: 0.7;
      }
      .divider::before,
      .divider::after {
        content: "";
        flex: 1;
        height: 1px;
        border-top: 1px solid var(--border-grey);
      }
      .muted-note {
        opacity: 0.75;
        font-size: 0.85rem;
      }
      .onboarding-card {
        margin-top: 1.5rem;
        padding: 1.25rem;
        border-radius: 22px;
        background: var(--white);
        border: 1px solid var(--border-grey);
      }
      .onboarding-card h5 {
        font-size: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="login-shell">
      <div class="text-center mb-4">
        <div class="brand-mark">{{ gym_name }}</div>
        <p class="muted-note">Modern POS + Member Suite</p>
      </div>
      <div id="onboarding" class="onboarding-card" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Quick Setup</h5>
          <button
            class="btn btn-sm btn-outline-secondary"
            onclick="skipOnboarding()"
          >
            Skip
          </button>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Gym Name</label>
            <input
              id="ob_gym_name"
              class="form-control"
              placeholder="Your Gym Name"
            />
          </div>
          <div class="col-md-6">
            <label class="form-label">Purpose</label>
            <input
              id="ob_purpose"
              class="form-control"
              placeholder="e.g., Fitness training"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">Currency</label>
            <select id="ob_currency" class="form-select">
              <option>USD</option>
              <option>PKR</option>
              <option>INR</option>
              <option>EUR</option>
              <option>GBP</option>
              <option>AED</option>
              <option>SAR</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Monthly Price</label>
            <input
              id="ob_price"
              type="number"
              min="0"
              step="0.01"
              class="form-control"
              value="8"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">Logo (optional)</label>
            <input
              id="ob_logo"
              type="file"
              accept="image/*"
              class="form-control"
            />
          </div>
          <div class="col-12">
            <label class="form-label">Features</label>
            <div class="d-flex flex-wrap gap-3 small">
              <label
                ><input
                  type="checkbox"
                  class="form-check-input me-1"
                  value="members"
                  checked
                />
                Members</label
              >
              <label
                ><input
                  type="checkbox"
                  class="form-check-input me-1"
                  value="fees"
                  checked
                />
                Fees</label
              >
              <label
                ><input
                  type="checkbox"
                  class="form-check-input me-1"
                  value="whatsapp"
                />
                WhatsApp</label
              >
              <label
                ><input
                  type="checkbox"
                  class="form-check-input me-1"
                  value="backup"
                />
                Backup</label
              >
            </div>
          </div>
        </div>
        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-custom flex-grow-1" onclick="saveOnboarding()">
            Save & Continue
          </button>
          <button class="btn btn-outline-light" onclick="skipOnboarding()">
            Skip for now
          </button>
        </div>
      </div>
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, msg in messages %}
      <div class="alert alert-{{ category }} py-2 mb-3">{{ msg }}</div>
      {% endfor %} {% endif %} {% endwith %}
      <form method="post" class="d-flex flex-column gap-3">
        <div>
          <label class="form-label" for="username">Username</label>
          <input
            class="form-control form-control-lg"
            name="username"
            id="username"
            required
          />
        </div>
        <div>
          <label class="form-label" for="password">Password</label>
          <input
            class="form-control form-control-lg"
            name="password"
            id="password"
            type="password"
            required
          />
        </div>
        <button class="btn btn-custom btn-lg mt-2" type="submit">
          Sign in
        </button>
      </form>
      <div class="divider my-4">or</div>
      {% if google_ready %}
      <div class="d-grid gap-2">
        <button
          class="btn btn-google"
          type="button"
          onclick="window.location.href='/login/google'"
        >
          <img
            src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
            alt="Google"
          />
          <span>Sign in with Google</span>
        </button>
        <div
          id="g_id_onload"
          data-client_id="{{ google_client_id }}"
          data-context="signin"
          data-ux_mode="popup"
          data-callback="handleCredentialResponse"
          data-auto_prompt="false"
        ></div>
      </div>
      {% else %}
      <div class="alert alert-secondary py-2 text-center small mb-0">
        Configure <strong>{{ ', '.join(google_missing) }}</strong> to enable
        Google sign-in.
      </div>
      {% endif %}
      <p class="muted-note text-center mt-3 mb-0">
        Need an account? <a class="link-light" href="/register">Create one</a>
      </p>
    </div>
    <script>
      async function loadOnboarding() {
        try {
          const r = await fetch('/onboarding/status');
          const j = await r.json();
          if (j.needed) {
            document.getElementById('onboarding').style.display = '';
            document.getElementById('ob_gym_name').value = j.settings.gym_name || '';
            document.getElementById('ob_purpose').value = j.settings.gym_purpose || '';
            document.getElementById('ob_currency').value = j.settings.currency_code || 'USD';
            document.getElementById('ob_price').value = j.settings.monthly_price || '8';
          }
        } catch (err) {}
      }
      async function saveOnboarding() {
        const name = document.getElementById('ob_gym_name').value.trim();
        const purpose = document.getElementById('ob_purpose').value.trim();
        const currency = document.getElementById('ob_currency').value;
        const price = document.getElementById('ob_price').value;
        const checks = Array.from(document.querySelectorAll('#onboarding input[type=checkbox]:checked')).map((x) => x.value);
        const logoInput = document.getElementById('ob_logo');
        const file = logoInput.files && logoInput.files[0];
        if (file) {
          const fd = new FormData();
          fd.append('logo', file);
          await fetch('/onboarding/logo', { method: 'POST', body: fd });
        }
        await fetch('/onboarding/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            gym_name: name,
            gym_purpose: purpose,
            currency_code: currency,
            monthly_price: price,
            features: checks,
          }),
        });
        location.reload();
      }
      async function skipOnboarding() {
        await fetch('/onboarding/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ skip: true }),
        });
        location.reload();
      }
      loadOnboarding();
      {% if google_ready %}
      window.handleCredentialResponse = async function (resp) {
        try {
          const res = await fetch('/auth/google/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ credential: resp.credential }),
          });
          const data = await res.json();
          if (data.ok) {
            window.location.href = '/dashboard';
          } else {
            alert('Google sign-in failed: ' + (data.error || 'unknown'));
          }
        } catch (err) {
          alert('Google login error');
        }
      };
      {% endif %}
    </script>
  </body>
</html>
