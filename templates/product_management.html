<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Product Management - {{ gym_name }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #020617;
        color: #f8fafc;
        font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      }
      .glass-panel {
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.15);
        border-radius: 24px;
        padding: 1.5rem;
        box-shadow: 0 20px 45px rgba(2, 6, 23, 0.6);
      }
      .product-card {
        border-radius: 20px;
        padding: 1.25rem;
        background: rgba(2, 6, 23, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.18);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container-xxl py-4">
      <div
        class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4"
      >
        <div>
          <h2 class="mb-0">Product Management</h2>
          <small class="text-muted">{{ gym_name }}</small>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-secondary" href="/pos">POS</a>
          <a class="btn btn-outline-secondary" href="/pos/sales">Sales</a>
          <a class="btn btn-outline-secondary" href="/pos/admin">Admin</a>
          <a class="btn btn-outline-danger" href="/logout">Logout</a>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-lg-4">
          <div class="glass-panel">
            <h5 class="mb-3 text-success">Add Product</h5>
            <form id="addForm" class="d-flex flex-column gap-3">
              <input
                class="form-control"
                name="name"
                placeholder="Name"
                required
              />
              <input
                class="form-control"
                name="price"
                type="number"
                min="0"
                step="0.01"
                placeholder="Price"
                required
              />
              <input
                class="form-control"
                name="stock"
                type="number"
                min="0"
                placeholder="Stock"
                required
              />
              <input
                class="form-control"
                name="category"
                placeholder="Category"
              />
              <input class="form-control" name="sku" placeholder="SKU" />
              <button class="btn btn-success" type="submit">Add Product</button>
            </form>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="glass-panel mb-4">
            <div class="row g-3 align-items-end">
              <div class="col-md-4">
                <label class="form-label">Search</label>
                <input
                  class="form-control"
                  id="pmSearch"
                  placeholder="Search products"
                />
              </div>
              <div class="col-md-4">
                <label class="form-label">Category</label>
                <select class="form-select" id="pmCategory">
                  <option value="">All</option>
                  {% for cat in categories %}
                  <option value="{{ cat }}">{{ cat }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Max Price</label>
                <input
                  type="number"
                  class="form-control"
                  id="pmMaxPrice"
                  min="0"
                  placeholder="No limit"
                />
              </div>
            </div>
          </div>
          <div class="glass-panel">
            <div id="pmGrid" class="product-grid"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title">Edit Product</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editForm" class="d-flex flex-column gap-3">
              <input type="hidden" name="id" />
              <input
                class="form-control"
                name="name"
                placeholder="Name"
                required
              />
              <input
                class="form-control"
                name="price"
                type="number"
                min="0"
                step="0.01"
                placeholder="Price"
                required
              />
              <input
                class="form-control"
                name="stock"
                type="number"
                min="0"
                placeholder="Stock"
                required
              />
              <input
                class="form-control"
                name="category"
                placeholder="Category"
              />
              <input class="form-control" name="sku" placeholder="SKU" />
              <select class="form-select" name="is_active">
                <option value="true">Active</option>
                <option value="false">Hidden</option>
              </select>
            </form>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-light" data-bs-dismiss="modal">
              Close
            </button>
            <button class="btn btn-success" id="saveEdit">Save</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let products = {{ products|tojson }};
      const grid = document.getElementById('pmGrid');
      const searchInput = document.getElementById('pmSearch');
      const categoryFilter = document.getElementById('pmCategory');
      const priceFilter = document.getElementById('pmMaxPrice');
      const editModalEl = document.getElementById('editModal');
      const editModal = new bootstrap.Modal(editModalEl);
      const editForm = document.getElementById('editForm');
      const editIdInput = editForm.querySelector('input[name="id"]');

      function renderProducts() {
        const search = searchInput.value.toLowerCase();
        const category = categoryFilter.value;
        const maxPrice = Number(priceFilter.value || Infinity);
        const filtered = products.filter((p) => {
          const matchesSearch = p.name.toLowerCase().includes(search) || (p.sku || '').toLowerCase().includes(search);
          const matchesCategory = !category || (p.category || '').toLowerCase() === category.toLowerCase();
          const matchesPrice = !priceFilter.value || p.price <= maxPrice;
          return matchesSearch && matchesCategory && matchesPrice;
        });
        grid.innerHTML = filtered
          .map(
            (p) => `
            <div class="product-card">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>${p.name}</strong>
                  <div class="small text-muted">${p.category || 'General'}</div>
                </div>
                <span class="badge text-bg-dark">${p.price.toFixed(2)}</span>
              </div>
              <div class="small text-muted">Stock: ${p.stock}</div>
              <div class="small">SKU: ${p.sku || '-'}</div>
              <div class="small">Status: ${p.is_active ? 'Active' : 'Hidden'}</div>
              <div class="d-flex gap-2 mt-2">
                <button class="btn btn-sm btn-outline-light flex-grow-1" data-edit="${p.id}">Edit</button>
                <button class="btn btn-sm btn-outline-danger" data-delete="${p.id}"><i class="bi bi-trash"></i></button>
              </div>
            </div>`
          )
          .join('');
        grid.querySelectorAll('button[data-edit]').forEach((btn) => btn.addEventListener('click', () => openEditForm(Number(btn.dataset.edit))));
        grid.querySelectorAll('button[data-delete]').forEach((btn) => btn.addEventListener('click', () => deleteProduct(Number(btn.dataset.delete))));
      }

      async function deleteProduct(id) {
        if (!confirm('Delete this product?')) return;
        const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.ok) {
          products = products.filter((p) => p.id !== id);
          renderProducts();
          showToast('Product deleted successfully', 'success');
        } else {
          showToast(data.error || 'Delete failed', 'danger');
        }
      }

      function openEditForm(id) {
        const product = products.find((p) => p.id === id);
        if (!product) return;
        editIdInput.value = product.id;
        editForm.name.value = product.name;
        editForm.price.value = product.price;
        editForm.stock.value = product.stock;
        editForm.category.value = product.category || '';
        editForm.sku.value = product.sku || '';
        editForm.is_active.value = product.is_active ? 'true' : 'false';
        editModal.show();
      }

      document.getElementById('saveEdit').addEventListener('click', async () => {
        const id = editIdInput.value;
        const payload = {
          name: editForm.name.value,
          price: editForm.price.value,
          stock: editForm.stock.value,
          category: editForm.category.value,
          sku: editForm.sku.value,
          is_active: editForm.is_active.value === 'true',
        };
        const res = await fetch(`/api/products/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (data.ok) {
          products = products.map((p) => (p.id === Number(id) ? data.product : p));
          renderProducts();
          editModal.hide();
          showToast('Product updated successfully', 'success');
        } else {
          showToast(data.error || 'Update failed', 'danger');
        }
      });

      document.getElementById('addForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const payload = Object.fromEntries(new FormData(form).entries());
        const res = await fetch('/api/products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (data.ok) {
          products.unshift(data.product);
          form.reset();
          renderProducts();
          showToast('Product added successfully', 'success');
        } else {
          showToast(data.error || 'Failed to add product', 'danger');
        }
      });

      searchInput.addEventListener('input', renderProducts);
      categoryFilter.addEventListener('change', renderProducts);
      priceFilter.addEventListener('input', renderProducts);

      renderProducts();
    </script>
    
    <!-- Toast Notification Container -->
    <div id="toastArea" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
    
    <script>
      // Toast notification function
      function showToast(message, type) {
        try {
          const area = document.getElementById('toastArea');
          const level = (type || 'success').toLowerCase();
          const cls = level === 'success' ? 'text-bg-success' : level === 'warning' ? 'text-bg-warning' : level === 'info' ? 'text-bg-info' : 'text-bg-danger';
          const el = document.createElement('div');
          el.className = `toast align-items-center ${cls} border-0`;
          el.setAttribute('role', 'alert');
          el.setAttribute('aria-live', 'assertive');
          el.setAttribute('aria-atomic', 'true');
          el.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
          area.appendChild(el);
          const t = new bootstrap.Toast(el, { delay: 3500 });
          t.show();
          el.addEventListener('hidden.bs.toast', () => el.remove());
        } catch (e) {
          alert(message);
        }
      }
    </script>
  </body>
</html>
