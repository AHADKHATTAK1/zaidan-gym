<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Excel Dashboard - {{ gym_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { padding: 20px; }
        .dashboard-card { margin-bottom: 20px; }
        #dataTable { width: 100%; }
        .last-updated { color: #6c757d; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <nav class="navbar navbar-expand bg-dark rounded px-3 mb-4 shadow-sm">
            <a class="navbar-brand" href="/dashboard">
                <i class="bi bi-graph-up"></i> {{ gym_name }}
            </a>
            <div class="ms-auto d-flex gap-2">
                <a href="/dashboard" class="btn btn-sm btn-outline-light">Back to Dashboard</a>
                <a href="/members" class="btn btn-sm btn-outline-light">Members</a>
                <a href="/fees" class="btn btn-sm btn-outline-light">Fees</a>
                <a href="/logout" class="btn btn-sm btn-outline-light">Logout</a>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="row">
            <div class="col-12">
                <div class="card dashboard-card bg-dark text-light">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4><i class="bi bi-file-earmark-excel"></i> Excel Data Dashboard (Auto-Updating)</h4>
                        <div>
                            <span class="last-updated">Last Updated: <span id="lastUpdated">Loading...</span></span>
                            <button class="btn btn-sm btn-outline-success ms-2" onclick="fetchData()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh Now
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            Place your Excel file as <strong>data_file.xlsx</strong> in the root directory. 
                            Data updates automatically every 5 seconds.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="row">
            <div class="col-lg-8">
                <div class="card dashboard-card bg-dark text-light">
                    <div class="card-header">
                        <h5><i class="bi bi-bar-chart-fill"></i> Visual Chart</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="myChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="col-lg-4">
                <div class="card dashboard-card bg-primary text-light">
                    <div class="card-body text-center">
                        <h6>Total Records</h6>
                        <h2 id="totalRecords">0</h2>
                    </div>
                </div>
                <div class="card dashboard-card bg-success text-light">
                    <div class="card-body text-center">
                        <h6>Total Value</h6>
                        <h2 id="totalValue">0</h2>
                    </div>
                </div>
                <div class="card dashboard-card bg-info text-dark">
                    <div class="card-body text-center">
                        <h6>Average Value</h6>
                        <h2 id="avgValue">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="row">
            <div class="col-12">
                <div class="card dashboard-card bg-dark text-light">
                    <div class="card-header">
                        <h5><i class="bi bi-table"></i> Latest Raw Data</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="dataTable" class="table table-striped table-hover table-dark">
                                <thead>
                                    <tr id="tableHeader"></tr>
                                </thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let myChart = null;
        let updateInterval = null;

        // Fetch data from API
        function fetchData() {
            fetch('/api/excel/data')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('lastUpdated').innerText = 'ERROR: ' + data.error;
                        return;
                    }
                    updateChart(data);
                    updateTable(data);
                    updateStats(data);
                    document.getElementById('lastUpdated').innerText = new Date().toLocaleTimeString();
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.getElementById('lastUpdated').innerText = 'ERROR';
                });
        }

        // Update Chart
        function updateChart(data) {
            if (!data || data.length === 0) return;

            // Try to find Category and Value columns (flexible)
            const keys = Object.keys(data[0]);
            const categoryKey = keys.find(k => k.toLowerCase().includes('category') || k.toLowerCase().includes('name')) || keys[0];
            const valueKey = keys.find(k => k.toLowerCase().includes('value') || k.toLowerCase().includes('amount') || k.toLowerCase().includes('count')) || keys[1];

            const labels = data.map(item => item[categoryKey]);
            const values = data.map(item => parseFloat(item[valueKey]) || 0);

            if (myChart) {
                myChart.data.labels = labels;
                myChart.data.datasets[0].data = values;
                myChart.update();
            } else {
                const ctx = document.getElementById('myChart').getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Data Values',
                            data: values,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: true, labels: { color: '#fff' } }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: { 
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            }
        }

        // Update Table
        function updateTable(data) {
            if (!data || data.length === 0) {
                document.getElementById('tableHeader').innerHTML = '<th>No Data</th>';
                document.getElementById('tableBody').innerHTML = '<tr><td>Excel file not found or empty</td></tr>';
                return;
            }

            // Generate table headers dynamically
            const headers = Object.keys(data[0]);
            const headerRow = headers.map(h => `<th>${h}</th>`).join('');
            document.getElementById('tableHeader').innerHTML = headerRow;

            // Generate table rows
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const row = tbody.insertRow();
                headers.forEach(header => {
                    const cell = row.insertCell();
                    cell.innerText = item[header] !== null && item[header] !== undefined ? item[header] : '';
                });
            });
        }

        // Update Stats
        function updateStats(data) {
            if (!data || data.length === 0) {
                document.getElementById('totalRecords').innerText = '0';
                document.getElementById('totalValue').innerText = '0';
                document.getElementById('avgValue').innerText = '0';
                return;
            }

            // Find value column
            const keys = Object.keys(data[0]);
            const valueKey = keys.find(k => 
                k.toLowerCase().includes('value') || 
                k.toLowerCase().includes('amount') || 
                k.toLowerCase().includes('count') ||
                k.toLowerCase().includes('total')
            ) || keys[1];

            const values = data.map(item => parseFloat(item[valueKey]) || 0);
            const total = values.reduce((sum, val) => sum + val, 0);
            const avg = values.length > 0 ? (total / values.length).toFixed(2) : 0;

            document.getElementById('totalRecords').innerText = data.length;
            document.getElementById('totalValue').innerText = total.toLocaleString();
            document.getElementById('avgValue').innerText = avg;
        }

        // Start auto-update (every 5 seconds)
        function startAutoUpdate() {
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(fetchData, 5000);
        }

        // Initial load
        fetchData();
        startAutoUpdate();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (updateInterval) clearInterval(updateInterval);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
