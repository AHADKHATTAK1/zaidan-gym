<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark">
    <!-- Cross-browser theme color support -->
    <style>
      html, body {
        background-color: #00C46C;
      }
      @media (prefers-color-scheme: dark) {
        html, body {
          background-color: #00C46C;
        }
      }
    </style>
    <meta name="msapplication-navbutton-color" content="#00C46C" />
    <meta name="msapplication-TileColor" content="#00C46C" />
    <meta name="apple-mobile-web-app-status-bar-style" content="#00C46C" />
    <link rel="icon" type="image/png" href="{{ logo_url or '/static/favicon.png' }}" />
    <link rel="apple-touch-icon" href="{{ logo_url or '/static/favicon.png' }}" />
    <link rel="manifest" href="/manifest.json" />
    <title>Fees - {{ gym_name }}</title>
    <script>
      (function () {
        try {
          var th = localStorage.getItem("theme") || "dark";
          document.documentElement.setAttribute("data-bs-theme", th);
        } catch (e) {}
      })();
    </script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/theme.css" />
    <style>
      /* Page specific header tweak */
      .app-header {
        border: 0 !important;
      }
      .app-header .btn {
        color: var(--white);
      }
    </style>
  </head>
  <body class="p-4">
    <div class="container">
      <nav class="navbar navbar-expand app-header rounded px-3 mb-4 shadow-sm">
        <a
          class="navbar-brand d-flex align-items-center gap-2"
          href="/dashboard"
        >
          {% if logo_url %}
          <img
            src="{{ logo_url }}"
            alt="{{ gym_name }} Logo"
            title="{{ gym_name }}"
            class="navbar-logo"
          />
          {% endif %}
          <span class="brand">{{ gym_name }}</span>
        </a>
        <div class="ms-auto d-flex align-items-center gap-2">
          <span class="fs-5" id="defaultFlag" title="Default Country"></span>
          <button
            class="btn btn-sm btn-outline-light"
            id="themeToggle"
            title="Toggle theme"
          >
            <i class="bi bi-moon-stars"></i>
          </button>
          <a class="btn btn-sm btn-outline-light me-2" href="/members"
            >Members</a
          >
          <a class="btn btn-sm btn-outline-light me-2" href="/fees">Fees</a>
          <a class="btn btn-sm btn-outline-light" href="/logout">Logout</a>
        </div>
      </nav>

      <h1>
        Monthly Fees
        <small class="text-muted fs-6">
          Default price: {{ monthly_price }} {{ currency_code }}/mo
        </small>
      </h1>
      <hr />

      <div class="row g-2 align-items-end mb-3">
        <div class="col-md-3">
          <label class="form-label">Year</label>
          <input id="year" class="form-control" type="number" placeholder="Enter year" title="Year" />
        </div>
        <div class="col-md-3">
          <label class="form-label" for="month">Month</label>
          <select id="month" class="form-select">
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <button
              type="button"
              class="btn btn-outline-primary flex-grow-1"
              onclick="refreshAll()"
            >
              Load
            </button>
          </select>
        </div>
        <div class="col-md-3">
          <div class="d-flex gap-2">
            <button
              class="btn btn-outline-primary flex-grow-1"
              onclick="refreshAll()"
            >
              Load
            </button>
            <div class="form-check form-switch d-flex align-items-center">
          <input
            class="form-check-input"
            id="autoRefresh"
            type="checkbox"
            title="Enable auto-refresh"
          />
              <label class="form-check-label ms-2" for="autoRefresh"
                >Auto</label
              >
            </div>
          </div>
        </div>
        <div class="col-md-3 text-end">
          <button class="btn btn-success" onclick="remindAll()">
            Remind All Unpaid
          </button>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-12">
          <div class="card">
            <div class="card-body d-flex flex-wrap gap-4 align-items-center">
              <div>
                <div class="text-muted small">Total Paid Fees</div>
                <div class="h5 mb-0">
                  <span id="sumPaid">0</span> {{ currency_code }}
                </div>
              </div>
              <div>
                <div class="text-muted small">Total Unpaid Fees</div>
                <div class="h5 mb-0">
                  <span id="sumUnpaid">0</span> {{ currency_code }}
                </div>
              </div>
              <div>
                <div class="text-muted small">Paid Members Count</div>
                <div class="h5 mb-0" id="cntPaid">0</div>
              </div>
              <div>
                <div class="text-muted small">Unpaid Members Count</div>
                <div class="h5 mb-0" id="cntUnpaid">0</div>
              </div>
              <div>
                <div class="text-muted small">Payment %</div>
                <div class="h5 mb-0" id="payPct">0%</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <div class="text-muted">Paid</div>
              <div id="paidCount" class="display-6 text-success">0</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <div class="text-muted">Unpaid</div>
              <div id="unpaidCount" class="display-6 text-warning">0</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <div class="text-muted">N/A</div>
              <div id="naCount" class="display-6 text-secondary">0</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <h4 id="unpaid">Unpaid</h4>
          <table class="table table-sm" id="unpaidTbl">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="col-md-6">
          <h4 id="paid">Paid</h4>
          <table class="table table-sm" id="paidTbl">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <h4 id="na" class="mt-4">N/A</h4>
          <div class="small text-muted">Count shown above</div>
        </div>
      </div>
    </div>

    <!-- Pay Confirmation Modal -->
    <div class="modal fade" id="payModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light border border-success">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-cash-coin"></i> Confirm Payment</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Payment Method</label>
              <select id="payMethod" class="form-select">
                <option value="cash" selected>Cash</option>
                <option value="bank">Bank</option>
            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
              <select id="payMethod" class="form-select">
                <option value="cash" selected>Cash</option>
                <option value="bank">Bank</option>
                <option value="online">Online</option>
              </select>
              <div class="form-text">Choose how the member paid.</div>
            </div> class="form-text">Blank uses member fee or gym monthly price.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
            <button id="payConfirmBtn" class="btn btn-success" data-member-id="" data-year="" data-month="">Confirm & Slip</button>
            <button type="button" class="btn btn-outline-warning" id="markUnpaidBtn">Mark Unpaid (This Month)</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Member Monthly Detail Modal -->
    <div class="modal fade" id="memberDetailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light border border-primary">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-list-check"></i> Monthly Details</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="memberDetailBody">
              <div class="text-muted">Loadingâ€¦</div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div id="toastArea" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <script>
      const CURRENCY = '{{ currency_code }}';
      // Theme toggle wiring
      (function(){
        var btn = document.getElementById('themeToggle');
        if (btn){
          btn.addEventListener('click', function(){
            var cur = document.documentElement.getAttribute('data-bs-theme') || 'dark';
            var next = cur === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-bs-theme', next);
            try{ localStorage.setItem('theme', next); }catch(e){}
          });
        }
      })();
      const DEFAULT_CC = '{{ default_cc }}';
      const CC_TO_ISO = { '92':'PK','91':'IN','1':'US','44':'GB','971':'AE','974':'QA','966':'SA','880':'BD','977':'NP','94':'LK','60':'MY','65':'SG','61':'AU','81':'JP','49':'DE','33':'FR','39':'IT','86':'CN','7':'RU','34':'ES','351':'PT','41':'CH','31':'NL','90':'TR','20':'EG','62':'ID','63':'PH','64':'NZ','82':'KR','55':'BR','52':'MX','27':'ZA','972':'IL','98':'IR','964':'IQ','965':'KW','968':'OM','973':'BH','216':'TN','213':'DZ','254':'KE','255':'TZ','256':'UG' };
      function isoToFlag(iso){ if(!iso) return 'ðŸŒ'; const up=iso.toUpperCase(); return String.fromCodePoint(...[...up].map(c=>127397+c.charCodeAt(0))); }
      function phoneToFlag(phone, defCC){
        if(!phone){ return isoToFlag(CC_TO_ISO[defCC]||''); }
        let p = phone.trim();
        if(p.startsWith('+')){
          p = p.slice(1);
          for (let len of [3,2,1]){
            const code = p.slice(0,len);
            if(CC_TO_ISO[code]) return isoToFlag(CC_TO_ISO[code]);
          }
          return 'ðŸŒ';
        }
        return isoToFlag(CC_TO_ISO[defCC]||'');
      }
      function setDefaults() {
        const url = new URL(window.location.href);
        const qYear = url.searchParams.get("year");
        const qMonth = url.searchParams.get("month");
        const now = new Date();
        document.getElementById("year").value = qYear
          ? parseInt(qYear, 10)
          : now.getFullYear();
        document.getElementById("month").value = qMonth
          ? qMonth
          : (now.getMonth() + 1).toString();
      }
      async function loadFees() {
        const y = document.getElementById("year").value;
        const m = document.getElementById("month").value;
        const res = await fetch(`/api/fees?year=${y}&month=${m}`);
        const rows = await res.json();
        const paid = rows.filter((r) => r.status === "Paid");
        const unpaid = rows.filter((r) => r.status === "Unpaid");
        const na = rows.filter((r) => r.status === "N/A");
        document.getElementById("paidCount").innerText = paid.length;
        document.getElementById("unpaidCount").innerText = unpaid.length;
        document.getElementById("naCount").innerText = na.length;
        const upT = document.querySelector("#unpaidTbl tbody");
        const pT = document.querySelector("#paidTbl tbody");
        upT.innerHTML = "";
        pT.innerHTML = "";
        unpaid.forEach((r) => {
          const tr = document.createElement("tr");
          const phoneRaw = r.member.phone || "";
          const flag = phoneToFlag(phoneRaw, DEFAULT_CC);
          tr.innerHTML = `<td>${r.member.serial}</td><td>${r.member.name}</td><td>${flag} ${phoneRaw}</td>
            <td>
              <button class="btn btn-sm btn-outline-success" onclick="remindSingle(${r.member.id})">Remind</button>
              <button class="btn btn-sm btn-outline-light ms-1" onclick="openMemberDetail(${r.member.id})"><i class="bi bi-list-check"></i> Detail</button>
              <button class="btn btn-sm btn-success ms-1" onclick="openPayModal(${r.member.id}, ${y}, ${m})"><i class="bi bi-cash-coin"></i> Pay & Slip</button>
            </td>`;
          upT.appendChild(tr);
        });
        paid.forEach((r) => {
          const tr = document.createElement("tr");
          const phoneRaw = r.member.phone || "";
          const flag = phoneToFlag(phoneRaw, DEFAULT_CC);
          tr.innerHTML = `<td>${r.member.serial}</td><td>${r.member.name}</td><td>${flag} ${phoneRaw}</td>
            <td>
              <button class="btn btn-sm btn-outline-light" onclick="openMemberDetail(${r.member.id})"><i class="bi bi-list-check"></i> Detail</button>
            </td>`;
          pT.appendChild(tr);
        });
      }

      async function loadSummary(){
        const y = document.getElementById('year').value;
        const m = document.getElementById('month').value;
        const res = await fetch(`/api/fees/summary?year=${y}&month=${m}`);
        const s = await res.json();
        if (!s.ok) return;
        document.getElementById('sumPaid').innerText = s.paid_total.toLocaleString();
        document.getElementById('sumUnpaid').innerText = s.unpaid_total.toLocaleString();
        document.getElementById('cntPaid').innerText = s.paid_count;
        document.getElementById('cntUnpaid').innerText = s.unpaid_count;
        document.getElementById('payPct').innerText = s.payment_percent + '%';
      }

      let refreshTimer = null;
      function refreshAll(){ loadFees(); loadSummary(); }
      function setAutoRefresh(){
        const on = document.getElementById('autoRefresh').checked;
        if (refreshTimer){ clearInterval(refreshTimer); refreshTimer = null; }
        if (on){ refreshTimer = setInterval(refreshAll, 30000); }
      }
      async function remindAll() {
        const y = document.getElementById("year").value;
        const m = document.getElementById("month").value;
        const res = await fetch(`/api/fees/remind?year=${y}&month=${m}`, {
          method: "POST",
        });
        const data = await res.json();
        if (data.ok) {
          showToast(`Reminders sent: ${data.sent} success, ${data.failed} failed`, "success");
        } else {
          showToast("Failed: " + (data.error || "unknown error"), "danger");
        }
      }
      async function remindSingle(memberId) {
        const res = await fetch(`/api/members/${memberId}/remind`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({}),
        });
        const data = await res.json();
        if (data.ok) {
          showToast("Reminder sent successfully", "success");
        } else {
          showToast("Failed: " + (data.error || "error"), "danger");
        }
      }
      setDefaults();
      refreshAll();
      // If there is a hash (#paid/#unpaid/#na), scroll to it after load
      window.addEventListener("load", () => {
        if (location.hash) {
          const el = document.querySelector(location.hash);
          if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
        }
        const df = document.getElementById('defaultFlag');
        if (df) df.textContent = isoToFlag(CC_TO_ISO[DEFAULT_CC]||'');
        setAutoRefresh();
        document.getElementById('autoRefresh').addEventListener('change', setAutoRefresh);
      });

      // Register Service Worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/static/service-worker.js')
          .then(reg => { /* SW registered */ })
          .catch(err => { /* SW registration failed */ });
      }

      // Payment Modal Functions
      let payModalInstance;
      function openPayModal(memberId, year, month, amount){
        const modalEl = document.getElementById('payModal');
        if(!payModalInstance){
          payModalInstance = new bootstrap.Modal(modalEl);
        }
        const btn = document.getElementById('payConfirmBtn');
        btn.dataset.memberId = String(memberId);
        btn.dataset.year = String(year);
        btn.dataset.month = String(month);
        document.getElementById('payMethod').value = 'cash';
        const amtEl = document.getElementById('payAmount');
        amtEl.value = amount != null && amount !== '' ? String(amount) : '';
        payModalInstance.show();
      }

      (function(){
        const btnUnpaid = document.getElementById('markUnpaidBtn');
        if(btnUnpaid){
          btnUnpaid.addEventListener('click', async function(){
            try{
              setLoading(btnUnpaid, true, 'Updatingâ€¦');
              const el = document.getElementById('payConfirmBtn');
              const memberId = parseInt(el.dataset.memberId||'0');
              const year = parseInt(el.dataset.year||'0');
              const month = parseInt(el.dataset.month||'0');
              if(!memberId || !year || !month){
                showToast('Missing details for unpaid toggle', 'danger');
                return;
              }
              const res = await fetch('/api/fees/mark-unpaid', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ member_id: memberId, year, month })
              });
              const data = await res.json();
              if(res.ok && data && data.ok){
                showToast('Marked as Unpaid', 'warning');
                try { payModalInstance?.hide(); } catch {}
                refreshAll();
              } else {
                showToast('Failed to mark unpaid', 'danger');
              }
            } catch(e){
              showToast('Error marking unpaid', 'danger');
            } finally {
              setLoading(btnUnpaid, false);
            }
          });
        }
      })();

      function showToast(message, type) {
        try {
          const area = document.getElementById('toastArea');
          const level = (type || 'success').toLowerCase();
          const cls = level === 'success' ? 'text-bg-success' : level === 'warning' ? 'text-bg-warning' : level === 'info' ? 'text-bg-info' : 'text-bg-danger';
          const el = document.createElement('div');
          el.className = `toast align-items-center ${cls} border-0`;
          el.setAttribute('role', 'alert');
          el.setAttribute('aria-live', 'assertive');
          el.setAttribute('aria-atomic', 'true');
          el.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
          area.appendChild(el);
          const t = new bootstrap.Toast(el, { delay: 3500 });
          t.show();
          el.addEventListener('hidden.bs.toast', () => el.remove());
        } catch (e) {
          alert(message);
        }
      }

      function setLoading(btn, loading, label){
        if (!btn) return;
        if (loading){
          btn.disabled = true;
          btn.dataset.label = btn.innerHTML;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>' + (label || 'Workingâ€¦');
        } else {
          btn.disabled = false;
          if (btn.dataset.label) btn.innerHTML = btn.dataset.label;
        }
      }

      (function(){
        const btn = document.getElementById('payConfirmBtn');
        if(!btn) return;
        btn.addEventListener('click', async function(){
          const memberId = parseInt(this.dataset.memberId || '0');
          const year = parseInt(this.dataset.year || '0');
          const month = parseInt(this.dataset.month || '0');
          const method = (document.getElementById('payMethod').value || 'cash');
          const amtStr = document.getElementById('payAmount').value;
          const amount = amtStr.trim() === '' ? undefined : parseFloat(amtStr);
          if(!memberId || !year || !month){
            showToast('Missing details for payment', 'danger');
            return;
          }
          try{
            setLoading(btn, true, 'Processingâ€¦');
            const payload = { member_id: memberId, year, month, method };
            if(typeof amount === 'number' && !Number.isNaN(amount)) payload.amount = amount;
            const res = await fetch('/api/payment/pay-now', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            let data = null;
            try { data = await res.json(); } catch {}
            if(res.ok && data && data.ok){
              showToast('Payment recorded. Opening receiptâ€¦', 'success');
              const url = data.receipt_url || `/receipt/member/${memberId}/${year}/${month}`;
              try { payModalInstance?.hide(); } catch {}
              window.open(url, '_blank');
              refreshAll();
            } else {
              const msg = data && data.error ? data.error : `HTTP ${res.status}`;
              showToast('Payment failed: ' + msg, 'danger');
            }
          } catch(e){
            showToast('Error processing payment', 'danger');
          } finally {
            setLoading(btn, false);
          }
        });
      })();

      // Member Detail Functions
      let memberDetailInstance;
      function monthName(n){
        const names=['January','February','March','April','May','June','July','August','September','October','November','December'];
        return names[(n-1) % 12];
      }
      async function openMemberDetail(memberId){
        const el = document.getElementById('memberDetailModal');
        if(!memberDetailInstance){ memberDetailInstance = new bootstrap.Modal(el); }
        memberDetailInstance.show();
        const body = document.getElementById('memberDetailBody');
        body.innerHTML = '<div class="text-muted">Loadingâ€¦</div>';
        try{
          const res = await fetch(`/api/members/${memberId}/payments`);
          const data = await res.json();
          let rows = [];
          let admissionDate = null;
          if(Array.isArray(data)){
            // Legacy format support
            rows = data;
          } else if(data && data.payments){
            rows = data.payments;
            admissionDate = data.admission_date ? new Date(data.admission_date) : null;
          }
          if(!Array.isArray(rows)){
            body.innerHTML = '<div class="text-danger">Failed to load payments.</div>';
            return;
          }
          // Filter to show only from admission date onwards (exclude N/A status)
          rows = rows.filter(p => p.status !== 'N/A');
          if(admissionDate){
            rows = rows.filter(p => {
              const payDate = new Date(p.year, p.month - 1, 1);
              const admMonth = new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1);
              return payDate >= admMonth;
            });
          }
          if(rows.length === 0){
            body.innerHTML = '<div class="text-muted">No payment records available from admission date.</div>';
            return;
          }
          const nowY = parseInt(document.getElementById('year').value || String(new Date().getFullYear()));
          const wrap = document.createElement('div');
          wrap.className = 'table-responsive';
          const tbl = document.createElement('table');
          tbl.className = 'table table-sm align-middle';
          tbl.innerHTML = `<thead><tr><th>Year</th><th>Month</th><th>Status</th><th>Amount</th><th>Actions</th></tr></thead>`;
          const tb = document.createElement('tbody');
          rows.forEach(p=>{
            const tr = document.createElement('tr');
            const badge = p.status==='Paid' ? '<span class="badge text-bg-success">Paid</span>' : p.status==='Unpaid' ? '<span class="badge text-bg-warning">Unpaid</span>' : '<span class="badge text-bg-secondary">N/A</span>';
            tr.innerHTML = `<td>${p.year}</td><td>${monthName(p.month)}</td><td>${badge}</td>
              <td><input type="number" class="form-control form-control-sm" min="0" step="0.01" placeholder="Amount" data-amt-for="${p.id}" /></td>
              <td>
                <button class="btn btn-sm btn-success me-1" ${p.status==='N/A'?'disabled':''} onclick="markPaidFor(${memberId}, ${p.year}, ${p.month}, ${p.id})"><i class="bi bi-cash-coin"></i> Mark Paid</button>
                <button class="btn btn-sm btn-outline-warning" ${p.status==='N/A'?'disabled':''} onclick="markUnpaid(${p.id})"><i class="bi bi-x-circle"></i> Mark Unpaid</button>
              </td>`;
            tb.appendChild(tr);
          });
          tbl.appendChild(tb);
          wrap.appendChild(tbl);
          body.innerHTML='';
          body.appendChild(wrap);
        } catch(e){
          body.innerHTML = '<div class="text-danger">Error loading details.</div>';
        }
      }

      async function markPaidFor(memberId, year, month, paymentId){
        // Read amount from input (optional)
        const input = document.querySelector(`input[data-amt-for='${paymentId}']`);
        const val = input && input.value ? parseFloat(input.value) : undefined;
        const payload = { member_id: memberId, year, month, method: 'cash' };
        if(typeof val === 'number' && !Number.isNaN(val)) payload.amount = val;
        try{
          const btn = event && event.target && event.target.closest('button');
          if(btn) setLoading(btn, true, 'Markingâ€¦');
          const res = await fetch('/api/fees/mark-paid', {
            method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload)
          });
          const data = await res.json();
          if(res.ok && data && data.ok){
            showToast('Marked as Paid', 'success');
            refreshAll();
            openMemberDetail(memberId);
          } else {
            showToast('Failed to mark paid', 'danger');
          }
        } catch(e){ showToast('Error marking paid', 'danger'); }
      }

      async function markUnpaid(paymentId){
        try{
          const btn = event && event.target && event.target.closest('button');
          if(btn) setLoading(btn, true, 'Updatingâ€¦');
          const res = await fetch(`/api/payments/${paymentId}`, {
            method: 'PUT', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ status: 'Unpaid' })
          });
          if(res.ok){
            showToast('Marked as Unpaid', 'warning');
            refreshAll();
          } else {
            showToast('Failed to mark unpaid', 'danger');
          }
        } catch(e){ showToast('Error marking unpaid', 'danger'); }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
