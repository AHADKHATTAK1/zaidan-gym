<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body { background-color: #00C46C !important; }
      @media (prefers-color-scheme: dark) {
        html, body { background-color: #222222 !important; }
      }
    </style>
    <meta name="msapplication-TileColor" content="#00C46C" />
    <meta name="msapplication-navbutton-color" content="#00C46C" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <link rel="icon" type="image/png" href="{{ logo_url or '/static/favicon.png' }}" />
    <link rel="apple-touch-icon" href="{{ logo_url or '/static/favicon.png' }}" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <title>Members - {{ gym_name }}</title>
    <script>
      (function () {
      try {
      var th = localStorage.getItem("theme") || "light";
      document.documentElement.setAttribute("data-bs-theme", th);
      } catch (e) {}
      })();
    </script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/theme.css" />
    <style>
      .badge-training { background: var(--light-grey); color: var(--charcoal); padding: 2px 6px; border-radius: 6px; font-size: .8rem; }
    </style>
    </head>
    <body class="p-4">
    <div class="container">
      <!-- Navbar -->
      <nav class="navbar navbar-expand border rounded px-3 mb-3">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/dashboard">
      {% if logo_url %}
      <img src="{{ logo_url }}" alt="{{ gym_name }} Logo" title="{{ gym_name }}" class="navbar-logo" />
      {% endif %}
      <span class="brand">{{ gym_name }}</span>
      </a>
      <div class="ms-auto d-flex align-items-center gap-2">
      <a class="btn btn-sm text-white" href="/dashboard">Dashboard</a>
      <a class="btn btn-sm text-white" href="/fees">Fees</a>
      <a class="btn btn-sm btn-outline-danger" href="/logout">Logout</a>
      </div>
      </nav>

      <!-- Add Member Form -->
      <div class="d-flex align-items-center justify-content-between">
      <h3 class="mb-0">Add Member</h3>
      <span class="text-muted small"
      >Default: <span id="defaultFlagInline"></span> +{{ default_cc }}</span
      >
      </div>
      <form id="addForm" class="mb-4" enctype="multipart/form-data">
      <div class="row g-2 align-items-end">
      <div class="col-md-4">
      <input required class="form-control" id="name" placeholder="Name" />
      </div>
      <div class="col-md-3">
      <div class="input-group">
        <span class="input-group-text" id="phoneFlag">üåê</span>
        <input
        class="form-control"
        id="phone"
        placeholder="Phone (auto +{{ default_cc }} if missing)"
        />
      </div>
      </div>
      <div class="col-md-2">
      <input
        required
        class="form-control"
        id="admission_date"
        type="date"
        title="Admission Date"
        placeholder="Select admission date"
      />
      </div>
      <div class="col-md-2">
      <input
        class="form-control"
        id="monthly_fee"
        type="number"
        step="0.01"
        placeholder="Amount"
        title="Monthly Fee"
      />
      </div>
      <div
      class="col-md-1 form-check d-flex align-items-center gap-2 flex-wrap"
      >
      <input class="form-check-input" type="checkbox" id="init_paid" title="Mark as paid" />
      <label class="form-check-label" for="init_paid">Paid?</label>
      </div>
      <div class="col-md-2 d-flex gap-2 flex-wrap">
      <input
        type="file"
        id="photo"
        class="form-control form-control-sm"
        accept="image/*"
        title="Upload photo"
        aria-label="Upload photo"
      />
      <button
        class="btn btn-outline-secondary"
        type="button"
        id="btnAddStartCam"
        onclick="startAddCamera()"
        aria-label="Start camera"
        title="Start camera for photo"
      >
        <i class="bi bi-camera-video"></i>
      </button>
      <button class="btn btn-primary" type="submit">Add</button>
      </div>
      </div>
      <div class="row g-2 mt-1 align-items-end">
      <div class="col-md-3">
      <select class="form-select" id="training_type" aria-label="Training type" title="Select training type">
        <option value="standard">Gym</option>
        <option value="personal">Personal Training</option>
        <option value="cardio">Cardio</option>
        <option value="other">Other (Custom)</option>
      </select>
      </div>
      <div class="col-md-2 form-check d-flex align-items-center gap-2">
      <input class="form-check-input" type="checkbox" id="special_tag" />
      <label class="form-check-label" for="special_tag">Special</label>
      </div>
      <div class="col-md-12 mt-2">
      <div class="d-flex flex-column gap-2">
        <video
        id="addCamStream"
        class="d-none camera-preview"
        autoplay
        muted
        ></video>
        <div class="d-flex gap-2">
        <button
        class="btn btn-sm btn-outline-primary d-none"
        type="button"
        id="btnAddCapture"
        onclick="captureAddPhoto()"
        >
        <i class="bi bi-camera"></i> Capture
        </button>
        <button
        class="btn btn-sm btn-outline-danger d-none"
        type="button"
        id="btnAddStopCam"
        onclick="stopAddCamera()"
        >
        <i class="bi bi-x-circle"></i> Close
        </button>
        </div>
        <div class="small text-muted mt-1" id="addCaptureStatus"></div>
      </div>
      </div>
      </div>
      <div class="row g-2 mt-1 d-none" id="customTrainingRow">
      <div class="col-md-3">
      <input
        class="form-control"
        id="custom_training"
        placeholder="Custom training type"
      />
      </div>
      </div>
      </form>

      <!-- Members Section -->
      <h3 class="d-flex align-items-center justify-content-between">
      <span>Members</span>
      <div class="btn-group btn-group-sm" role="group" aria-label="View toggle">
      <button type="button" id="toggleViewCards" class="btn btn-outline-secondary active" onclick="setMemberView('cards')" aria-label="Card view" title="Card view"><i class="bi bi-grid"></i></button>
      <button type="button" id="toggleViewTable" class="btn btn-outline-secondary" onclick="setMemberView('table')" aria-label="Table view" title="Table view"><i class="bi bi-list"></i></button>
      </div>
      </h3>
      <div id="memberSummary" class="mb-2 small d-flex flex-wrap gap-2 align-items-center">
      <span class="badge bg-secondary">Total: <span id="countTotal">0</span></span>
      <span class="badge bg-success">Active: <span id="countActive">0</span></span>
      <span class="badge bg-secondary">Inactive: <span id="countInactive">0</span></span>
      </div>
      <div class="row g-2 mb-3" id="memberFilters">
      <div class="col-md-4">
      <input id="search" class="form-control" placeholder="Search by name, phone or #serial" aria-label="Search members" title="Search members" />
      </div>
      <div class="col-md-2">
      <select id="filterStatus" class="form-select" onchange="debouncedFetchMembers()" aria-label="Filter by status" title="Filter by status">
      <option value="">All Status</option>
      <option value="Paid">Paid</option>
      <option value="Unpaid">Unpaid</option>
      <option value="N/A">N/A</option>
      </select>
      </div>
      <div class="col-md-2">
      <select id="filterActive" class="form-select" onchange="debouncedFetchMembers()" aria-label="Filter by active status" title="Filter by active status">
      <option value="">All Members</option>
      <option value="1">Active</option>
      <option value="0">Inactive</option>
      </select>
      </div>
      <div class="col-md-2">
      <select id="filterTraining" class="form-select" onchange="debouncedFetchMembers()" aria-label="Filter by training type" title="Filter by training type">
      <option value="">All Training</option>
      <option value="standard">Standard</option>
      <option value="personal">Personal</option>
      <option value="cardio">Cardio</option>
      <option value="other">Custom</option>
      </select>
      </div>
      <div class="col-md-2">
      <select id="filterSpecial" class="form-select" onchange="debouncedFetchMembers()" aria-label="Filter by special tag" title="Filter by special tag">
      <option value="">Any Tag</option>
      <option value="1">Special ‚≠ê</option>
      <option value="0">Not Special</option>
      </select>
      </div>
      <div class="col-md-2 d-flex gap-2">
      <button class="btn btn-outline-primary w-100" type="button" onclick="debouncedFetchMembers()"><i class="bi bi-search"></i> Apply</button>
      </div>
      <div class="col-md-2 d-flex gap-2">
      <button class="btn btn-outline-success w-100" type="button" onclick="connectAll()"><i class="bi bi-link-45deg"></i> Connect All</button>
      </div>
      </div>
      <div id="members">
      <div class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">Loading members...</p>
      </div>
      </div>
      <hr />

      <!-- Data Uploads -->
      <div class="mb-4">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Data Uploads</h5>
          <button class="btn btn-sm btn-outline-primary" type="button" onclick="refreshUploads()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
        <form id="dataUploadForm" class="d-flex gap-2 align-items-center mb-3" enctype="multipart/form-data">
          <label for="dataUploadFile" class="form-label mb-0">Upload Data File</label>
          <input type="file" name="file" id="dataUploadFile" class="form-control" accept=".csv,.xlsx,.xls" title="Select a data file to upload" placeholder="Choose CSV or Excel file" />
          <button type="button" class="btn btn-success" onclick="uploadDataFile()">
            <i class="bi bi-upload"></i> Upload
          </button>
        </form>
        <div id="uploadsList" class="list-group small">
          <div class="text-muted">No uploads yet.</div>
        </div>
      </div>

      <!-- Edit Member Modal -->
      <div class="modal fade" id="editMemberModal" tabindex="-1">
      <div class="modal-dialog">
      <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Member</h5>
        <button
        type="button"
        class="btn-close"
        data-bs-dismiss="modal"
        aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="editMemberForm" class="vstack gap-3">
        <div>
        <label class="form-label">Name</label>
        <input class="form-control" id="edit_name" placeholder="Enter name" />
        </div>
        <div>
        <label class="form-label">Phone</label>
        <input class="form-control" id="edit_phone" placeholder="Enter phone number" />
        </div>
        <div>
        <label class="form-label">Admission Date</label>
        <input type="date" class="form-control" id="edit_admission" title="Admission Date" placeholder="Select admission date" />
        </div>
        <div>
        <label class="form-label" for="edit_access">Access Tier</label>
        <select class="form-select" id="edit_access" title="Select access tier">
        <option value="yearly">Yearly</option>
        </select>
        </div>
        <div>
        <label class="form-label">Training Type</label>
        <select class="form-select" id="edit_training_type" title="Select training type" onchange="toggleEditCustomTraining()">
        <option value="standard">Gym</option>
        <option value="personal">Personal</option>
        <option value="cardio">Cardio</option>
        <option value="other">Other (Custom)</option>
        </select>
        </div>
        <div id="edit_custom_training_wrap" class="d-none">
        <label class="form-label">Custom Training</label>
        <input
        class="form-control"
        id="edit_custom_training"
        placeholder="e.g. CrossFit"
        />
        </div>
        <div>
        <label class="form-label">Monthly Fee (override)</label>
        <input
        type="number"
        step="0.01"
        class="form-control"
        id="edit_monthly_fee"
        placeholder="Leave blank for default"
        />
        </div>
        <div class="form-check">
        <input
        class="form-check-input"
        type="checkbox"
        id="edit_special_tag"
        />
        <label class="form-check-label" for="edit_special_tag">Special Tag</label>
        </div>
        <div>
        <label class="form-label">Photo</label>
        <input type="file" class="form-control" id="edit_photo" accept="image/*" title="Upload photo" placeholder="Upload photo" />
        <div class="mt-2">
        <video
                        id="camStream"
                        autoplay
                        class="w-100 rounded border d-none edit-camera-preview"
                      ></video>
                        Start Camera
                    <div class="mt-2">
                      <video
                        id="camStream"
                        autoplay
                        class="w-100 rounded border d-none edit-camera-preview"
                      ></video>
                        Start Camera
                      ></video>
                      <canvas
                        id="editCamCanvas"
                        class="w-100 rounded border d-none edit-camera-preview"
                      ></canvas>
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-secondary"
                        id="btnStartCam"
                        onclick="startCamera()"
                      >
                        Start Camera
                      </button>
                        type="button"
                        class="btn btn-sm btn-outline-secondary d-none"
                        id="btnStopCam"
                        onclick="stopCamera()"
                      >
                        Stop
                      </button>
                    </div>
                    <div id="captureStatus" class="small text-muted"></div>
                  </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Close
              </button>
              <button type="button" class="btn btn-primary" onclick="saveEdit()">
                Save Changes
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Member Details Modal -->
      <div class="modal fade" id="memberDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-header">
              <h5 class="modal-title">Member Details</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    data-bs-toggle="tab"
                    data-bs-target="#tab-payments"
                    type="button"
                    role="tab"
                    aria-controls="tab-payments"
                    aria-selected="true"
                  >
                    Payments
                  </button>
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    data-bs-toggle="tab"
                    data-bs-target="#tab-transactions"
                    type="button"
                    role="tab"
                    aria-controls="tab-transactions"
                    aria-selected="false"
                  >
                    Transactions
                  </button>
                </li>
              </ul>
              <div class="tab-content border-start border-end border-bottom p-3" id="detailsTabContent">
                <div class="tab-pane fade show active" id="tab-payments" role="tabpanel" aria-labelledby="tab-payments-tab">
                  <!-- Payments content -->
                </div>
                <div class="tab-pane fade" id="tab-transactions" role="tabpanel" aria-labelledby="tab-transactions-tab">
                  <!-- Transactions content -->
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Bootstrap JS Bundle (required for modals) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // Trigger members fetch on load with a safe fallback
    window.addEventListener('DOMContentLoaded', () => {
      try {
        if (typeof debouncedFetchMembers === 'function') {
          debouncedFetchMembers();
        } else if (typeof fetchMembers === 'function') {
          fetchMembers();
        } else {
          fallbackFetchMembers();
        }
      } catch (e) {
        try { fallbackFetchMembers(); } catch (_) {}
      }
    });

    function renderMembers(list) {
      const container = document.getElementById('members');
      if (!Array.isArray(list) || list.length === 0) {
        container.innerHTML = '<div class="text-muted">No members found.</div>';
        return;
      }
      const html = list.map(m => {
        const phone = m.phone ? m.phone : '';
        const adm = m.admission_date ? m.admission_date : '';
        const ttype = m.training_type ? m.training_type : '';
        const fee = (m.monthly_fee !== null && m.monthly_fee !== undefined) ? m.monthly_fee : '';
        const photoUrl = m.photo_url ? m.photo_url : '/static/uploads/default-avatar.png';
        return `
          <div class="card mb-2">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="d-flex gap-3 align-items-center">
                  <img src="${photoUrl}" alt="${m.name}" class="rounded-circle" width="50" height="50" style="object-fit:cover;" onerror="this.src='/static/uploads/default-avatar.png'" />
                  <div>
                    <div class="fw-semibold">${m.name || 'Unnamed'}</div>
                    <div class="text-muted small">${phone}</div>
                    <div class="text-muted small">Admission: ${adm} ‚Ä¢ ${ttype}${fee !== '' ? ` ‚Ä¢ Fee: ${fee}` : ''}</div>
                  </div>
                </div>
                <div class="d-flex gap-1 flex-wrap">
                  <button class="btn btn-sm btn-outline-primary" onclick="openMemberDetails(${m.id})" title="View Details"><i class="bi bi-eye"></i> View</button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="openEditMember(${m.id})" title="Edit Member"><i class="bi bi-pencil"></i> Edit</button>
                  <button class="btn btn-sm btn-outline-success" onclick="payThisMonth(${m.id})" title="Pay This Month"><i class="bi bi-cash-coin"></i> Pay</button>
                  <button class="btn btn-sm btn-outline-info" onclick="uploadPhoto(${m.id})" title="Upload Photo"><i class="bi bi-camera"></i> Photo</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteMember(${m.id})" title="Delete Member"><i class="bi bi-trash"></i> Delete</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      container.innerHTML = html;
    }

    async function openMemberDetails(memberId) {
      try {
        const res = await fetch(`/api/member/${memberId}/payment-history`);
        if (!res.ok) throw new Error('Failed to load member details');
        const js = await res.json();
        const m = js.member || {};
        const pays = Array.isArray(js.payments) ? js.payments : [];
        // Build payments table
        let payHtml = '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr>'+
          '<th>Year</th><th>Month</th><th>Status</th><th>Amount</th><th>Paid Date</th></tr></thead><tbody>';
        payHtml += pays.map(p => `
          <tr>
            <td>${p.year}</td>
            <td>${p.month_name || p.month}</td>
            <td>${p.status}</td>
            <td>${p.amount ?? ''}</td>
            <td>${p.paid_date ?? ''}</td>
          </tr>
        `).join('');
        payHtml += '</tbody></table></div>';
        const payTab = document.getElementById('tab-payments');
        if (payTab) payTab.innerHTML = `
          <div class="mb-2"><strong>${m.name || ''}</strong> ‚Äî ${m.phone || ''}</div>
          ${payHtml}
        `;
        // Build transactions table
        const txTab = document.getElementById('tab-transactions');
        if (txTab) {
          const txRes = await fetch(`/api/members/${memberId}/payments`);
          const txList = await txRes.json();
          let txHtml = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Date</th><th>Month</th><th>Amount</th><th>Method</th></tr></thead><tbody>';
          if (Array.isArray(txList) && txList.length > 0) {
            txHtml += txList.map(t => `<tr><td>${t.created_at || ''}</td><td>${t.month || ''}</td><td>${t.amount || ''}</td><td>${t.method || ''}</td></tr>`).join('');
          } else {
            txHtml += '<tr><td colspan="4" class="text-muted">No transactions</td></tr>';
          }
          txHtml += '</tbody></table></div>';
          txTab.innerHTML = txHtml;
        }
        const modalEl = document.getElementById('memberDetailsModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      } catch (e) {
        console.error(e);
        if (typeof showToast === 'function') showToast('Failed to load member details');
      }
    }

    async function openEditMember(memberId) {
      try {
        const res = await fetch(`/api/members?search=${memberId}`);
        const list = await res.json();
        const m = Array.isArray(list) ? list.find(x => x.id === memberId) : null;
        if (!m) throw new Error('Member not found');
        document.getElementById('edit_name').value = m.name || '';
        document.getElementById('edit_phone').value = m.phone || '';
        document.getElementById('edit_admission').value = m.admission_date || '';
        document.getElementById('edit_monthly_fee').value = m.monthly_fee ?? '';
        document.getElementById('edit_training_type').value = m.training_type || 'standard';
        document.getElementById('edit_special_tag').checked = !!m.special_tag;
        document.getElementById('edit_custom_training').value = m.custom_training || '';
        if (m.training_type === 'other') {
          document.getElementById('edit_custom_training_wrap').classList.remove('d-none');
        }
        window.currentEditMemberId = memberId;
        const modalEl = document.getElementById('editMemberModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      } catch (e) {
        console.error(e);
        if (typeof showToast === 'function') showToast('Failed to load member for edit');
      }
    }

    async function saveEdit() {
      const memberId = window.currentEditMemberId;
      if (!memberId) return;
      const data = {
        name: document.getElementById('edit_name').value.trim(),
        phone: document.getElementById('edit_phone').value.trim(),
        admission_date: document.getElementById('edit_admission').value,
        monthly_fee: document.getElementById('edit_monthly_fee').value || null,
        training_type: document.getElementById('edit_training_type').value,
        special_tag: document.getElementById('edit_special_tag').checked,
        custom_training: document.getElementById('edit_custom_training').value.trim() || null
      };
      try {
        const res = await fetch(`/api/members/${memberId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const js = await res.json();
        if (res.ok && js.ok) {
          if (typeof showToast === 'function') showToast('Member updated');
          bootstrap.Modal.getInstance(document.getElementById('editMemberModal'))?.hide();
          fallbackFetchMembers();
        } else {
          if (typeof showToast === 'function') showToast('Failed to update member', 'danger');
        }
      } catch (e) {
        console.error(e);
        if (typeof showToast === 'function') showToast('Error updating member', 'danger');
      }
    }

    async function payThisMonth(memberId) {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      const payload = { member_id: memberId, year, month, method: 'cash' };
      try {
        const res = await fetch('/api/payment/pay-now', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const js = await res.json();
        if (res.ok && js.ok) {
          if (typeof showToast === 'function') showToast('Payment recorded. Opening receipt...');
          window.open(js.receipt_url, '_blank');
          fallbackFetchMembers();
        } else {
          if (typeof showToast === 'function') showToast('Payment failed: ' + (js.error || 'unknown'), 'danger');
        }
      } catch (e) {
        console.error(e);
        if (typeof showToast === 'function') showToast('Error processing payment', 'danger');
      }
    }

    async function uploadPhoto(memberId) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const fd = new FormData();
        fd.append('photo', file);
        try {
          const res = await fetch(`/api/members/${memberId}/photo`, {
            method: 'POST',
            body: fd
          });
          const js = await res.json();
          if (res.ok && js.ok) {
            if (typeof showToast === 'function') showToast('Photo uploaded');
            fallbackFetchMembers();
          } else {
            if (typeof showToast === 'function') showToast('Upload failed', 'danger');
          }
        } catch (err) {
          console.error(err);
          if (typeof showToast === 'function') showToast('Error uploading photo', 'danger');
        }
      };
      input.click();
    }

    async function deleteMember(memberId) {
      if (!confirm('Delete this member and all payment records?')) return;
      try {
        const res = await fetch(`/api/members/${memberId}`, { method: 'DELETE' });
        const js = await res.json();
        if (res.ok && js.ok) {
          if (typeof showToast === 'function') showToast('Member deleted');
          fallbackFetchMembers();
        } else {
          if (typeof showToast === 'function') showToast('Delete failed', 'danger');
        }
      } catch (e) {
        console.error(e);
        if (typeof showToast === 'function') showToast('Error deleting member', 'danger');
      }
    }

    async function fallbackFetchMembers() {
      const container = document.getElementById('members');
      // 10s timeout guard
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), 10000);
      try {
        const params = new URLSearchParams();
        const q = document.getElementById('search')?.value?.trim();
        if (q) params.set('search', q);
        const res = await fetch('/api/members' + (params.toString() ? ('?' + params.toString()) : ''), { signal: controller.signal });
        if (!res.ok) throw new Error('Members API error');
        const list = await res.json();
        if (!Array.isArray(list)) throw new Error('Unexpected response');
        renderMembers(list);
      } catch (e) {
        const retry = '<button class="btn btn-sm btn-outline-secondary" onclick="fallbackFetchMembers()">Retry</button>';
        container.innerHTML = '<div class="text-danger">Could not load members.</div>' + retry;
      } finally {
        clearTimeout(t);
      }
    }
    </script>

    <script>
    async function refreshUploads() {
      try {
        const res = await fetch('/api/uploads');
        const items = await res.json();
        const wrap = document.getElementById('uploadsList');
        wrap.innerHTML = '';
        if (!items || items.length === 0) {
          wrap.innerHTML = '<div class="text-muted">No uploads yet.</div>';
          return;
        }
        items.forEach((f) => {
          const row = document.createElement('div');
          row.className = 'list-group-item d-flex justify-content-between align-items-center';
          row.innerHTML = `
            <div>
              <div class="fw-semibold">${f.original_name}</div>
              <div class="text-muted">Rows: ${f.rows_count ?? 0} ‚Ä¢ Uploaded: ${new Date(f.uploaded_at).toLocaleString()}</div>
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="viewUpload(${f.id})">
                <i class="bi bi-eye"></i> View Rows
              </button>
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteUpload(${f.id})">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          `;
          wrap.appendChild(row);
        });
      } catch (e) {
        console.error(e);
      }
    }

    async function uploadDataFile() {
      const form = document.getElementById('dataUploadForm');
      const fd = new FormData(form);
      const file = fd.get('file');
      if (!file || !file.name) return;
      try {
        const res = await fetch('/api/uploads', { method: 'POST', body: fd });
        const js = await res.json();
        if (js && js.ok) {
          if (typeof showToast === 'function') showToast('Upload complete');
          refreshUploads();
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function viewUpload(id) {
      try {
        const res = await fetch(`/api/uploads/${id}`);
        const js = await res.json();
        const rows = js.rows || [];
        const modalBody = document.getElementById('uploadRowsBody');
        if (!rows.length) {
          modalBody.innerHTML = '<div class="text-muted">No row snapshot available.</div>';
        } else {
          // Build a small table from the first row's keys
          const cols = Object.keys(rows[0]);
          let html = '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr>' +
            cols.map(c => `<th>${c}</th>`).join('') + '</tr></thead><tbody>';
          rows.forEach(r => {
            html += '<tr>' + cols.map(c => `<td>${r[c] ?? ''}</td>`).join('') + '</tr>';
          });
          html += '</tbody></table></div>';
          modalBody.innerHTML = html;
        }
        const m = new bootstrap.Modal(document.getElementById('uploadRowsModal'));
        m.show();
      } catch (e) {
        console.error(e);
      }
    }

    async function deleteUpload(id) {
      if (!confirm('Delete this upload?')) return;
      try {
        const res = await fetch(`/api/uploads/${id}`, { method: 'DELETE' });
        const js = await res.json();
        if (js && js.ok) {
          if (typeof showToast === 'function') showToast('Upload deleted');
          refreshUploads();
        }
      } catch (e) {
        console.error(e);
      }
    }

    function toggleEditCustomTraining() {
      const sel = document.getElementById('edit_training_type');
      const wrap = document.getElementById('edit_custom_training_wrap');
      if (sel.value === 'other') {
        wrap.classList.remove('d-none');
      } else {
        wrap.classList.add('d-none');
      }
    }

    // Initial load for uploads
    refreshUploads();
  </script>

  <!-- Upload Rows Modal -->
  <div class="modal fade" id="uploadRowsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upload Rows Snapshot</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="uploadRowsBody">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  </body>
</html>
